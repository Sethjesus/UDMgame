<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#16a34a" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>ğŸ¾ JP ESG ç¢³ç›¤æ¨‚ v5.4.4ï¼ˆCSV åˆä½µ/è¦†è“‹ï¼‹Top-Right Toastï¼‰</title>

  <!-- âœ… PWA -->
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />


  <style>
    :root{ --ink:#0f172a; --panel:#ffffffcc; --shadow:0 10px 24px rgba(0,0,0,.08); --bg:#f7fbff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-rounded,"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;color:var(--ink);
      background:radial-gradient(1200px 800px at 20% -10%, #e6f5ff 0, transparent 60%),radial-gradient(1200px 800px at 120% 0, #ecfff3 0, transparent 60%),var(--bg);
      display:flex;align-items:center;justify-content:center;padding:14px}
    .app{max-width:1240px;width:100%}
    .topbar{display:flex;gap:10px;justify-content:space-between;align-items:center;background:var(--panel);backdrop-filter:blur(10px);border-radius:18px;padding:10px 12px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand img{width:34px;height:34px;border-radius:50%;box-shadow:0 4px 0 #22c55e}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#fff;box-shadow:var(--shadow);font-weight:800}
    .btn{border:none;background:#fff;border-radius:999px;padding:9px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 #e5e7eb}
    .btn:active{transform:translateY(3px);box-shadow:0 2px 0 rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg,#bef264,#86efac);color:#064e3b;box-shadow:0 6px 0 #22c55e}
    .btn.blue{background:linear-gradient(180deg,#bae6fd,#93c5fd);color:#08324a;box-shadow:0 6px 0 #60a5fa}
    .arena{margin-top:12px}
    .board{position:relative;height:min(64vh,620px);min-height:500px;width:100%;border-radius:22px;overflow:hidden;outline:6px solid #fff;border:3px dashed #bbf7d0;box-shadow:var(--shadow)}
    .bg-forest{background:linear-gradient(180deg,#ecfdf5,#e0ffe9)}
    .bg-city{background:linear-gradient(180deg,#eff6ff,#e0f2ff)}
    .bg-ocean{background:linear-gradient(180deg,#e0f2fe,#e0f7fa)}
    .back-illus{position:absolute;right:8px;bottom:6px;font-size:56px;opacity:.25;pointer-events:none}
    .hud{position:absolute;left:10px;top:10px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;z-index:2}
    .hud .tag{border-radius:999px;padding:6px 10px;background:#fff;box-shadow:var(--shadow);font-weight:800}
    .goalbar{position:absolute;left:10px;right:10px;top:46px;height:10px;background:#fff;border-radius:999px;box-shadow:var(--shadow)}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#86efac,#60a5fa);border-radius:999px;transition:width .25s}
    .hpbar{position:absolute;left:10px;right:10px;top:64px;height:12px;background:#fee2e2;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);display:none}
    .hpfill{height:100%;width:100%;background:linear-gradient(90deg,#fecaca,#ef4444)}
    .token{position:absolute;width:84px;height:84px;cursor:pointer}
    .bubble{position:absolute;inset:0;border-radius:22px;background:radial-gradient(circle at 30% 25%, #fff 0 30%, #eafff0 68%);border:3px solid #bbf7d0;box-shadow:0 10px 20px rgba(22,163,74,.18);display:grid;place-items:center;transition:transform .12s}
    .bubble:active{transform:scale(.92)}
    .emoji{font-size:40px;filter:drop-shadow(0 3px 0 rgba(0,0,0,.08))}
    .tree{position:absolute;bottom:6px;left:0;transform:translateX(var(--x,0));font-size:24px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.15))}
    .toast{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;padding:8px 12px;box-shadow:var(--shadow);font-weight:900;opacity:0;z-index:3}
    .toast.show{animation:toast .9s ease both}
    @keyframes toast{0%{opacity:0;transform:translate(-50%,-50%) scale(.9)}14%{opacity:1;transform:translate(-50%,-50%) scale(1)}86%{opacity:1}100%{opacity:0}}
    .boss{position:absolute;width:130px;height:130px;border-radius:50%;left:50%;top:56%;transform:translate(-50%,-50%);background:radial-gradient(circle at 40% 35%, #374151 0 45%, #111827 70%);box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 -8px 20px rgba(255,255,255,.05);display:grid;place-items:center;z-index:1}
    .boss::after{content:"ğŸ‘€";font-size:40px;transform:translateY(-6px)}
    .boss.aura{box-shadow:0 10px 30px rgba(0,0,0,.25),0 0 22px rgba(239,68,68,.6), inset 0 -8px 20px rgba(255,255,255,.05)}
    .shockwave{position:absolute;left:50%;top:56%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;border:3px solid rgba(239,68,68,.8);opacity:.8;animation:boom 1.2s ease-out both;z-index:1}
    @keyframes boom{from{width:20px;height:20px;opacity:.85}to{width:500px;height:500px;opacity:0}}
    .missile{position:absolute;width:18px;height:18px;border-radius:50%;background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,.7);z-index:1}
    .drain{position:absolute;left:50%;top:56%;transform:translate(-50%,-50%);width:190px;height:190px;border-radius:50%;box-shadow:inset 0 0 22px rgba(59,130,246,.55);opacity:.85;animation:pulse 1.2s ease-in-out infinite;z-index:1}
    @keyframes pulse{0%{transform:translate(-50%,-50%) scale(.9)}50%{transform:translate(-50%,-50%) scale(1.05)}100%{transform:translate(-50%,-50%) scale(.9)}
    }
    .confetti{position:fixed;width:8px;height:14px;top:-10px;left:50%;border-radius:2px;opacity:.9;animation:fall 1.6s linear forwards;z-index:5}
    @keyframes fall{to{transform:translateY(120vh) rotate(540deg);opacity:0}}
    .fade-enter{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:50}
    .modal.show{display:flex}
    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:var(--shadow);width:min(95vw,1040px)}
    .card h3{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
    .node{border:2px dashed #d1fae5;border-radius:12px;padding:10px}
    .tabbar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 10px;overflow-x:auto;white-space:nowrap}

    /* --- Quest Pager --- */
    .pager-wrap{display:flex;flex-direction:column;gap:10px}
    .pager{position:relative;overflow:hidden;border-radius:14px}
    .pager-track{display:flex;transition:transform .28s ease;will-change: transform;}
    .pager-page{min-width:100%;padding:10px;box-sizing:border-box}
    .pager-nav{display:flex;gap:8px;align-items:center;justify-content:center}
    .pager-dot{width:8px;height:8px;border-radius:50%;background:#e5e7eb}
    .pager-dot.active{background:#16a34a}
    .pager-btn{border:none;border-radius:10px;padding:6px 10px;background:#fff;box-shadow:0 4px 0 #e5e7eb;cursor:pointer}

    /* âœ… å…¨æ©«åˆ—ç‰ˆä»»å‹™æ¨£å¼ï¼ˆæ©«å‘æ²å‹•ï¼‰ */
    .todo-list{list-style:none;padding:0;margin:8px 0;display:flex;flex-wrap:nowrap;gap:14px;overflow-x:auto;scroll-snap-type:x mandatory}
    .todo-list::-webkit-scrollbar{height:8px}
    .todo-list::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    .todo-list li{flex:0 0 300px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);scroll-snap-align:start;display:flex;flex-direction:column;justify-content:space-between}
    .todo-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .todo-top label{display:flex;align-items:center;gap:10px;font-size:16px;line-height:1.4}
    .todo-badge{font-size:13px;color:#0f172a99;background:#f3f4f6;border-radius:10px;padding:2px 8px;min-width:64px;text-align:center}
    .todo-bar{height:6px;border-radius:6px;background:#f1f5f9;overflow:hidden;margin-top:4px}
    .todo-fill{height:100%;width:0;background:linear-gradient(90deg,#86efac,#60a5fa)}

    /* âœ… GHG 14064 å°ç…§æ“´å……è¡¨æ ¼ */
    .ghg-table{width:100%;border-collapse:collapse;margin-top:12px;min-width:820px}
    .ghg-table th,.ghg-table td{border:1px solid #d1d5db;padding:6px 10px;text-align:left;vertical-align:top}
    .ghg-table th{background:#f3f4f6}
    .ghg-table caption{caption-side:top;font-weight:700;margin-bottom:8px}

    @media (max-width:680px){ .controls{gap:6px} .chip{padding:6px 10px} .token{width:74px;height:74px} }

    /* ===== Quest ç‰ˆé¢ä¸€è‡´åŒ–ä¿®æ­£ ===== */
    #questModal .pager-page { padding: 0; }
    #questModal .pager-page > .grid { margin: 0; display:block; }
    #questModal .pager-page > .grid > .node { width: 100%; }

    #questModal .node .node { padding: 0; border: none; box-shadow: none; }

    #questModal .todo-list { padding: 0 8px; margin: 8px 0; }
    #questModal .todo-list li { flex: 0 0 280px; }
    #questModal .todo-top { margin-bottom: 6px; }

    #questModal .ghg-table { min-width: 960px; width: 100%; }
    #questModal .node[style*="overflow:auto"] { max-width: 100%; }

    #questModal .card { max-height: 86vh; overflow: auto; }
    #questModal { overflow-y: auto; }

    /* ğŸ“² å®‰è£æŒ‰éˆ•ï¼ˆå…§åµŒåœ¨æ§åˆ¶åˆ—ï¼‰ */
    #installBtn {
      display:none;
      box-shadow:0 6px 0 #22c55e;
      background:linear-gradient(180deg,#bbf7d0,#86efac);
      color:#064e3b;
    }

    /* ğŸ” åŒ¯å…¥æ¨¡å¼åˆ‡æ›å°éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ */
    .mode-pill{
      border:none;border-radius:999px;padding:6px 10px;font-weight:800;
      background:#f1f5f9;color:#0f172a; box-shadow:0 4px 0 #e5e7eb; cursor:pointer;
    }
    .mode-pill.merge{background:linear-gradient(180deg,#e2fbe8,#bcf0da); color:#065f46;}
    .mode-pill.over{background:linear-gradient(180deg,#fee2e2,#fecaca); color:#7f1d1d;}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <img src="https://github.com/Sethjesus/Photo/blob/main/UDM%20New%20Logo.jpg?raw=true" alt="UDM Logo"/>
      <div style="display:flex;flex-direction:column;line-height:1.1">
        <b id="title">ç¢³ç›¤æ¨‚ ESG v5.4.4</b>
        <small id="subtitle" style="opacity:.8">UDMï½œé‚Šç©é‚Šå­¸</small>
      </div>
    </div>
    <div class="controls">
      <span class="chip">ğŸ‘¤ <b id="player">Player</b></span>
      <span class="chip">é—œå¡ï¼š<b id="level">1</b>/10</span>
      <span class="chip">é›£åº¦ï¼š
        <select id="difficulty" aria-label="é¸æ“‡é›£åº¦">
          <option value="easy">ç°¡å–®</option>
          <option value="normal" selected>æ™®é€š</option>
          <option value="hard">å›°é›£</option>
        </select>
      </span>
      <span class="chip" id="scoreChip">ESG åˆ†æ•¸ï¼š<b id="score">0</b></span>
      <span class="chip"><span id="treesLabel">å·²ç¨®æ¨¹ï¼š</span><b id="trees">0</b> æ£µ</span>
      <button class="btn" id="mapBtn">ğŸ—ºï¸ åœ°åœ–</button>
      <button class="btn" id="treeBtn">ğŸŒ³ åœ–é‘‘</button>
      <button class="btn" id="questBtn">ğŸ“… ä»»å‹™</button>
      <button class="btn" id="quizBtn">ğŸ§  å°çŸ¥è­˜</button>
      <button class="btn" id="factsBtn">ğŸ“š çŸ¥è­˜åº«</button>
      <button class="btn" id="achBtn">ğŸ† æˆå°±</button>
      <button class="btn" id="lbBtn">â­ æ’è¡Œ</button>
      <button class="btn" id="musicBtn">ğŸµ éŸ³æ¨‚</button>
      <button class="btn" id="nameBtn">ğŸ“ åç¨±</button>
      <button class="btn primary" id="startBtn">é–‹å§‹</button>
      <button class="btn blue" id="pauseBtn">æš«åœ</button>
      <button class="btn" id="soundBtn" aria-pressed="false">ğŸ”ˆ</button>
      <button class="btn" id="resetAllBtn">â™»ï¸ é‡ç½®ç´€éŒ„</button>

      <!-- ğŸ“² PWA ä¸‹è¼‰ -->
      <button class="btn" id="installBtn">ğŸ“² ä¸‹è¼‰</button>
    </div>
  </div>

  <div class="arena">
    <div class="board bg-forest" id="board">
      <div class="back-illus" id="illus">ğŸŒ²</div>
      <div class="hud">
        <span class="tag">ğŸ”¥ <b id="combo">0x</b></span>
        <span class="tag">â± <b id="time">60</b>s</span>
        <span class="tag">ğŸ¯ ç›®æ¨™ï¼š<b id="goal">120</b></span>
      </div>
      <div class="goalbar"><div class="fill" id="goalFill"></div></div>
      <div class="hpbar" id="hpbar"><div class="hpfill" id="hpfill"></div></div>
    </div>
    <div class="hint" id="versionNote"></div>
  </div>
</div>

<!-- å–å -->
<div class="modal" id="nameModal"><div class="card">
  <h3>å–å€‹åå­—å§</h3>
  <div class="node"><input id="nameInput" placeholder="ä½ çš„åå­—" style="width:100%"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" id="resetName">é‡ç½®åç¨±</button>
    <button class="btn primary" id="saveName">å„²å­˜</button>
  </div>
</div></div>

<!-- åœ°åœ– -->
<div class="modal" id="mapModal"><div class="card">
  <h3>ğŸ—ºï¸ é—œå¡åœ°åœ–</h3>
  <div class="grid" id="mapGrid"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="resetProgress">é‡ç½®é€²åº¦</button><button class="btn" data-close="mapModal">é—œé–‰</button></div>
</div></div>

<!-- åœ–é‘‘ -->
<div class="modal" id="treeModal"><div class="card">
  <h3>ğŸŒ³ æ¨¹ç¨®åœ–é‘‘</h3>
  <div class="grid" id="dexGrid"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" id="resetDex">é‡ç½®åœ–é‘‘</button>
    <button class="btn" data-close="treeModal">é—œé–‰</button>
  </div>
</div></div>

<!-- ä»»å‹™ä¸­å¿ƒï¼ˆPager 5 é ï¼‰ -->
<div class="modal" id="questModal">
  <div class="card">
    <h3>ğŸ“… ä»»å‹™ä¸­å¿ƒ</h3>

    <div class="pager-wrap">
      <div class="pager" id="questPager">
        <div class="pager-track" id="questTrack">
          <!-- 0ï¼šæ¯æ—¥ -->
          <section class="pager-page">
            <div class="grid">
              <div class="node">
                <b>ğŸ¯ æ¯æ—¥ä»»å‹™</b>
                <ul id="dailyList" class="todo-list"></ul>
              </div>
            </div>
          </section>
          <!-- 1ï¼šæ¯é€± -->
          <section class="pager-page">
            <div class="grid">
              <div class="node">
                <b>ğŸ“† æ¯é€±ä»»å‹™</b>
                <ul id="weeklyList" class="todo-list"></ul>
              </div>
            </div>
          </section>
          <!-- 2ï¼šæ¸…å–®ï¼ˆS1/S2/S3ï¼‰ -->
          <section class="pager-page">
            <div class="grid">
              <div class="node">
                <b>ğŸ“‘ ç¢³ç›¤æŸ¥ä»»å‹™æµï¼ˆS1 / S2 / S3ï¼‰</b>
                <table class="table" style="width:100%;border-collapse:separate;border-spacing:0 6px">
                  <tbody id="ghgBody"></tbody>
                </table>
              </div>
            </div>
          </section>
          <!-- 3ï¼šGHG / ISO 14064-1 å°ç…§è¡¨ï¼ˆè¡¨æ ¼ï¼‰ -->
          <section class="pager-page">
            <div class="grid">
              <div class="node">
                <b>ğŸ§¾ GHG / ISO 14064-1 å°ç…§è¡¨</b>
                <div class="node" style="overflow:auto">
                  <table class="ghg-table">
                    <thead>
                      <tr><th>ç’°ä¿ç½²è¦ç¯„ç¯„ç–‡</th><th>GHG Protocol</th><th>ISO 14064-1:2018</th></tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><b>ç›¤æŸ¥æº«å®¤æ°£é«”</b></td>
                        <td>äº¬éƒ½è­°å®šæ›¸æ¶µè“‹ COâ‚‚ã€CHâ‚„ã€Nâ‚‚Oã€SFâ‚†ã€HFCsã€PFCs ç­‰ 6 é¡æ°£é«”ï¼›å…¶ä»–æ°£é«”å¦è¡Œæ­éœ²ã€‚</td>
                        <td>å¸¸ç”¨æ¸…å–®å« COâ‚‚ã€CHâ‚„ã€Nâ‚‚Oã€NFâ‚ƒã€SFâ‚†ã€HFCsã€PFCs ç­‰ã€‚</td>
                      </tr>
                      <tr>
                        <td><b>ç›´æ¥æ’æ”¾</b></td>
                        <td>ç¯„ç–‡ 1ï¼šç›´æ¥æº«å®¤æ°£é«”æ’æ”¾</td>
                        <td>é¡åˆ¥ 1ï¼šç›´æ¥æº«å®¤æ°£é«”æ’æ”¾èˆ‡ç§»é™¤</td>
                      </tr>
                      <tr>
                        <td><b>èƒ½æºé–“æ¥æ’æ”¾</b></td>
                        <td>ç¯„ç–‡ 2ï¼šé›»åŠ›ä¹‹é–“æ¥æº«å®¤æ°£é«”æ’æ”¾</td>
                        <td>é¡åˆ¥ 2ï¼šé€²å£èƒ½æºçš„é–“æ¥æº«å®¤æ°£é«”æ’æ”¾</td>
                      </tr>
                      <tr>
                        <td><b>å…¶ä»–é–“æ¥æ’æ”¾</b></td>
                        <td>ç¯„ç–‡ 3ï¼šå…¶ä»–é–“æ¥æ’æ”¾ï¼ˆ15 é¡ï¼‰</td>
                        <td>é¡åˆ¥ 3â€“6ï¼šé‹è¼¸ã€ç”¢å“ä½¿ç”¨ã€ç¯„åœå¤–é–“æ¥æ’æ”¾èˆ‡å…¶ä»–ä¾†æºé–“æ¥æ’æ”¾</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section><!-- 4ï¼šç›¤æŸ¥å®šç¾©èˆ‡æ‡‰ç”¨å»¶ä¼¸ -->
          <section class="pager-page">
            <div class="grid">
              <div class="node">
                <b>ğŸ“˜ ç›¤æŸ¥å®šç¾©èˆ‡æ‡‰ç”¨å»¶ä¼¸</b>
                <div class="node" style="overflow:auto;margin-top:8px">
                  <b>ğŸ§­ çµ„ç¹”é‚Šç•Œï¼ˆBoundary Definitionï¼‰</b>
                  <table class="ghg-table">
                    <thead><tr><th>é …ç›®</th><th>èªªæ˜</th></tr></thead>
                    <tbody>
                      <tr><td>è‚¡æ¬Šæ³• (Equity Share)</td><td>ä¾ä¼æ¥­åœ¨è¢«æŠ•è³‡å–®ä½ä¹‹æŒè‚¡æ¯”ä¾‹è¨ˆç®—æ’æ”¾é‡ã€‚</td></tr>
                      <tr><td>è²¡å‹™æ§åˆ¶ (Financial Control)</td><td>ä¼æ¥­å…·æœ‰è²¡å‹™æ±ºç­–æ¬Šï¼ˆé ç®—/è³‡æœ¬é…ç½®ç­‰ï¼‰è€…ï¼Œç´å…¥ç›¤æŸ¥é‚Šç•Œã€‚</td></tr>
                      <tr><td>ç‡Ÿé‹æ§åˆ¶ (Operational Control)</td><td>ä¼æ¥­èƒ½ä¸»å°æ—¥å¸¸ç‡Ÿé‹èˆ‡æ”¿ç­–è€…ï¼Œæ‡‰ç´å…¥ç›¤æŸ¥ã€‚</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="node" style="overflow:auto;margin-top:8px">
                  <b>ğŸ§© ç‡Ÿé‹æ§åˆ¶æ³•æ‡‰ç”¨</b>
                  <table class="ghg-table">
                    <thead><tr><th>åˆ†é¡</th><th>ç¯„ä¾‹</th><th>æ˜¯å¦ç´å…¥ç›¤æŸ¥</th></tr></thead>
                    <tbody>
                      <tr><td>å…¬å¸è‡ªæœ‰å» æˆ¿èˆ‡è¨­å‚™</td><td>è‡ªç‡Ÿç”Ÿç”¢ç·šã€è¾¦å…¬å®¤</td><td>âœ… æ˜¯</td></tr>
                      <tr><td>å§”å¤–åŠ å·¥å» </td><td>ç„¡æ—¥å¸¸ç®¡ç†æ¬Š</td><td>âŒ å¦ï¼ˆå¯åˆ—å…¥ S3ï¼‰</td></tr>
                      <tr><td>åˆè³‡ä¼æ¥­</td><td>æŒè‚¡ä½†ç„¡ç‡Ÿé‹æ§åˆ¶æ¬Š</td><td>â– ä¾è‚¡æ¬Šæ³•æŒ‰æ¯”ä¾‹åˆ—å…¥</td></tr>
                      <tr><td>å§”å¤–ç‰©æµæˆ–ç§Ÿè³ƒ</td><td>ç”±ç¬¬ä¸‰æ–¹é‹ä½œ</td><td>âœ… è‹¥ç”±ä¼æ¥­æŒ‡æ®é‹ä½œå‰‡ç´å…¥</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="node" style="overflow:auto;margin-top:8px">
                  <b>ğŸ”„ ç¢³ç›¤æŸ¥æµç¨‹ï¼ˆCarbon Inventory Flowï¼‰</b>
                  <table class="ghg-table">
                    <thead><tr><th>æ­¥é©Ÿ</th><th>èªªæ˜</th></tr></thead>
                    <tbody>
                      <tr><td>1. ç•Œå®šçµ„ç¹”èˆ‡ç‡Ÿé‹é‚Šç•Œ</td><td>ç¢ºèªç›¤æŸ¥å°è±¡ç¯„åœï¼ˆå«å­å…¬å¸ã€å·¥å» ã€è¾¦å…¬å®¤ï¼‰ã€‚</td></tr>
                      <tr><td>2. è¾¨è­˜æ’æ”¾æº</td><td>ç›¤é»èƒ½æºã€ç‡ƒæ–™ã€è¨­å‚™ã€é‹è¼¸ã€å»¢æ£„ç‰©ç­‰ä¾†æºã€‚</td></tr>
                      <tr><td>3. è’é›†æ´»å‹•æ•¸æ“š</td><td>ç‡ƒæ–™é‡ã€é›»è¡¨åº¦æ•¸ã€é‡Œç¨‹ã€å™¸å…¬é‡Œã€é‡é‡ç­‰ã€‚</td></tr>
                      <tr><td>4. å¥—ç”¨æ’æ”¾ä¿‚æ•¸</td><td>é¸ç”¨æ”¿åºœæˆ–åœ‹éš›æŒ‡å—ï¼ˆIPCCã€EPAã€DEFRAã€åœ¨åœ°é›»åŠ›ä¿‚æ•¸ï¼‰ã€‚</td></tr>
                      <tr><td>5. è¨ˆç®—æ’æ”¾é‡</td><td>æ´»å‹•æ•¸æ“š Ã— æ’æ”¾ä¿‚æ•¸ï¼ˆå¿…è¦æ™‚ä¹˜ä»¥ GWPï¼‰ã€‚</td></tr>
                      <tr><td>6. å¯©æŸ¥èˆ‡æŸ¥é©—</td><td>å…§éƒ¨æˆ–ç¬¬ä¸‰æ–¹å¯©æŸ¥è³‡æ–™ä¾†æºã€é‚Šç•Œèˆ‡è¨ˆç®—é‚è¼¯ã€‚</td></tr>
                      <tr><td>7. æ­éœ²èˆ‡æ”¹å–„</td><td>å¹´åº¦å ±å‘Šæ­éœ²ä¸¦è¨­å®šæ¸›ç¢³ç›®æ¨™èˆ‡è¡Œå‹•ã€‚</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="node" style="margin-top:8px">
                  <div class="node">
                    ğŸ“ <a href="https://www.idipckeelung.org.tw/%E3%80%90%E8%A3%9C%E5%8A%A9%E8%B3%87%E8%A8%8A%E3%80%91%E5%9B%A0%E6%87%89%E4%B8%AD%E5%B0%8F%E4%BC%81%E6%A5%AD%E9%9C%80%E6%B1%82%EF%BC%8C%E7%94%B3%E8%AB%8B%E6%97%A5%E6%9C%9F%E6%8B%89%E9%95%B7%E8%87%B312/"
                    target="_blank" rel="noopener"><b>ğŸ‘‰ é»æˆ‘å‰å¾€ç”³è«‹ 16+4 ç¢³ç›¤æŸ¥è£œåŠ©è¨ˆç•«</b></a>
                  </div>
                </div>
                <div class="node" style="overflow:auto;margin-top:8px">
                  <b>âš™ï¸ æ’æ”¾ä¿‚æ•¸ç¯„ä¾‹ï¼ˆç¤ºæ„ï¼‰</b>
                  <table class="ghg-table">
                    <thead><tr><th>é¡åˆ¥</th><th>å–®ä½</th><th>åƒè€ƒä¿‚æ•¸ï¼ˆkgCOâ‚‚eï¼‰</th><th>å¸¸è¦‹ä¾†æº</th></tr></thead>
                    <tbody>
                      <tr><td>é›»åŠ›ï¼ˆå°ç£åœ°å€ï¼‰</td><td>kWh</td><td>0.495</td><td>ç’°ä¿ç½²/èƒ½æºå±€å…¬å¸ƒä¹‹å¹´åº¦ä¿‚æ•¸</td></tr>
                      <tr><td>æ±½æ²¹</td><td>L</td><td>2.27</td><td>IPCC 2006</td></tr>
                      <tr><td>æŸ´æ²¹</td><td>L</td><td>2.68</td><td>IPCC 2006</td></tr>
                      <tr><td>å¤©ç„¶æ°£</td><td>NmÂ³</td><td>2.05</td><td>èƒ½æºå±€å› å­</td></tr>
                      <tr><td>å“¡å·¥é€šå‹¤ï¼ˆå°å®¢è»Šï¼‰</td><td>km</td><td>0.21</td><td>DEFRA 2023</td></tr>
                      <tr><td>å»¢æ£„ç‰©æ©åŸ‹</td><td>kg</td><td>0.45</td><td>EPA WARM</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
      <div class="pager-nav">
        <button class="pager-btn" id="questPrev">â—€</button>
        <span id="questDots" style="display:flex;gap:6px"></span>
        <button class="pager-btn" id="questNext">â–¶</button>
      </div>
    </div>

    <div style="text-align:right;margin-top:8px">
      <button class="btn" data-close="questModal">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- å•ç­” -->
<div class="modal" id="quizModal"><div class="card" style="position:relative">
  <h3>ğŸ§  å°çŸ¥è­˜å•ç­”</h3>

  <!-- ğŸ” åŒ¯å…¥æ¨¡å¼åˆ‡æ›ï¼ˆå³ä¸Šè§’ï¼‰ -->
  <div style="position:absolute; right:12px; top:12px; display:flex; gap:8px; align-items:center">
    <span style="font-size:12px;opacity:.7">CSV åŒ¯å…¥æ¨¡å¼</span>
    <button class="mode-pill merge" id="importModeBtn" title="é»æ“Šåˆ‡æ›ï¼šåˆä½µ / è¦†è“‹">åˆä½µ</button>
  </div>

  <div class="tabbar" id="qTabs"></div>
  <div class="node" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
    <input type="file" id="csvQ" accept=".csv"><button class="btn" id="importCsv">åŒ¯å…¥ CSV</button>
    <button class="btn" id="exportCsv">åŒ¯å‡º CSV</button>
    <span style="opacity:.7;font-size:12px">æ ¼å¼ï¼šcat,q,a1|a2|a3|a4,correct_index,why</span>
  </div>
  <div id="quizStats" class="node" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
    <div>ğŸ¯ ç¸½é¡Œæ•¸ï¼š<b id="statTotal">0</b></div>
    <div>âœ… ç­”å°ï¼š<b id="statRight">0</b></div>
    <div>âŒ ç­”éŒ¯ï¼š<b id="statWrong">0</b></div>
    <div>ğŸ“Š æ­£ç¢ºç‡ï¼š<b id="statAcc">0%</b></div>
  </div>
  <div id="quizBox"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn" id="nextQ">ä¸‹ä¸€é¡Œ</button>
    <button class="btn" data-close="quizModal">é—œé–‰</button>
  </div>
</div></div>

<!-- çŸ¥è­˜åº« -->
<div class="modal" id="factsModal"><div class="card">
  <h3>ğŸ“š çŸ¥è­˜åº«</h3>
  <ul id="factsList" style="line-height:1.8"></ul>
  <div style="text-align:right"><button class="btn" data-close="factsModal">é—œé–‰</button></div>
</div></div>

<!-- æˆå°± -->
<div class="modal" id="achModal"><div class="card">
  <h3>ğŸ† æˆå°±</h3>
  <div class="grid" id="achGrid"></div>
  <div style="text-align:right"><button class="btn" data-close="achModal">é—œé–‰</button></div>
</div></div>

<!-- æ’è¡Œ -->
<div class="modal" id="lbModal"><div class="card">
  <h3>â­ æ’è¡Œæ¦œ</h3>
  <table class="table" style="width:100%;border-collapse:separate;border-spacing:0 6px"><thead><tr><th>#</th><th>ç©å®¶</th><th>é—œå¡</th><th>åˆ†æ•¸</th><th>æ¨¹</th><th>æ—¥æœŸ</th></tr></thead><tbody id="lbBody"></tbody></table>
  <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:8px">
    <input id="firebaseUrl" placeholder="Firebase REST URL (å¯é¸)" style="flex:1;min-width:260px">
    <input id="sheetsUrl" placeholder="Google Apps Script éƒ¨ç½²ç¶²å€ (å¯é¸)" style="flex:1;min-width:260px">
    <button class="btn" id="pushOnline">ä¸Šå‚³</button>
    <button class="btn" id="pullOnline">æ›´æ–°</button>
    <button class="btn" id="clearLB">æ¸…ç©ºæ’è¡Œ</button>
    <button class="btn" data-close="lbModal">é—œé–‰</button>
  </div>
</div></div>

<!-- éŸ³æ¨‚ -->
<div class="modal" id="musicModal"><div class="card">
  <h3>ğŸµ éŸ³æ¨‚èˆ‡éŸ³é‡</h3>
  <div class="node" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div>
      <b>æ›²ç›®</b>
      <select id="musicSel" style="width:100%;margin-top:6px">
        <option value="auto">è‡ªå‹•è¼ªæ’­ï¼ˆéš¨é—œå¡ï¼‰</option>
        <option value="forest">æ£®æ—æ›²</option>
        <option value="city">åŸå¸‚æ›²</option>
        <option value="ocean">æµ·æ´‹æ›²</option>
        <option value="boss">Boss æ›²</option>
        <option value="rock">ğŸ¸ Rock æ¨¡å¼</option>
        <option value="none">ç„¡éŸ³æ¨‚</option>
      </select>
    </div>
    <div>
      <b>éŸ³é‡</b>
      <input id="vol" type="range" min="0" max="100" value="60"/>
      <div style="opacity:.75;font-size:12px">æ»‘å‹•èª¿æ•´éŸ³é‡</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn" id="musicPreview">è©¦è½</button>
    <button class="btn primary" id="musicSave">å¥—ç”¨</button>
    <button class="btn" data-close="musicModal">é—œé–‰</button>
  </div>
</div></div>

<script>
/* ===========================
   ğŸŒˆ å³ä¸Šè§’æµ®å‹• Toast ç³»çµ±
   =========================== */
(function initToastStyles(){
  if (document.getElementById('toastStyles')) return;
  const css = `
  #toastBox{
    position:fixed; right:20px; top:20px; z-index:9999;
    display:flex; flex-direction:column; align-items:flex-end; gap:10px; pointer-events:none;
  }
  .toast-note{
    pointer-events:auto; max-width:360px; color:#fff; background:rgba(15,23,42,.92);
    border-radius:14px; padding:10px 14px 12px 12px; box-shadow:0 8px 22px rgba(0,0,0,.28);
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:start;
    opacity:0; transform:translateX(20px);
    animation:toastIn .28s ease forwards;
  }
  .toast-icon{ font-size:18px; line-height:1; margin-top:2px; }
  .toast-body{ font-size:14px; line-height:1.45; }
  .toast-close{ background:transparent; border:none; color:#e2e8f0; font-size:16px; opacity:.8; cursor:pointer; }
  .toast-close:hover{ opacity:1; }
  .toast-bar{
    grid-column:1 / span 3; height:4px; border-radius:999px; overflow:hidden;
    background:rgba(255,255,255,.08); margin-top:6px;
  }
  .toast-bar > i{
    display:block; height:100%; width:100%;
    transform-origin:left center; animation:toastBar linear forwards;
  }
  /* é¡å‹é¡è‰² */
  .toast-success{ border:1px solid rgba(34,197,94,.45); }
  .toast-success .toast-bar > i{ background:linear-gradient(90deg,#86efac,#22c55e); }
  .toast-info{ border:1px solid rgba(59,130,246,.45); }
  .toast-info .toast-bar > i{ background:linear-gradient(90deg,#93c5fd,#3b82f6); }
  .toast-warn{ border:1px solid rgba(245,158,11,.45); }
  .toast-warn .toast-bar > i{ background:linear-gradient(90deg,#fcd34d,#f59e0b); }
  .toast-error{ border:1px solid rgba(239,68,68,.45); }
  .toast-error .toast-bar > i{ background:linear-gradient(90deg,#fca5a5,#ef4444); }
  @keyframes toastIn{ from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
  @keyframes toastOut{ to{opacity:0;transform:translateX(20px)} }
  @keyframes toastBar{ from{transform:scaleX(1)} to{transform:scaleX(0)} }
  `;
  const el = document.createElement('style');
  el.id = 'toastStyles';
  el.textContent = css;
  document.head.appendChild(el);
})();

function toast(msg, opts){
  if (typeof opts === 'number') opts = { duration: opts };
  opts = Object.assign({ type:'info', duration:3000, showProgress:true, icon:null, html:true }, opts||{});
  const iconMap = { success:'âœ…', info:'â„¹ï¸', warn:'âš ï¸', error:'âŒ' };
  const icon = opts.icon != null ? opts.icon : (iconMap[opts.type] || 'ğŸ””');
  let box = document.getElementById('toastBox');
  if (!box){ box = document.createElement('div'); box.id='toastBox'; document.body.appendChild(box); }
  const card = document.createElement('div');
  card.className = `toast-note toast-${opts.type}`;
  const iconEl = `<div class="toast-icon">${icon}</div>`;
  const body = opts.html ? String(msg) : String(msg).replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  const bodyEl = `<div class="toast-body">${body}</div>`;
  const closeEl = `<button class="toast-close" aria-label="close">âœ–</button>`;
  card.innerHTML = iconEl + bodyEl + closeEl + (opts.showProgress ? `<div class="toast-bar"><i style="animation-duration:${opts.duration}ms"></i></div>` : '');
  const onClose = () => { card.style.animation='toastOut .25s ease forwards'; setTimeout(()=>card.remove(),260); };
  card.querySelector('.toast-close').addEventListener('click', onClose);
  box.appendChild(card);
  const timer = setTimeout(onClose, opts.duration);
  card.addEventListener('mouseenter', ()=> clearTimeout(timer));
}
const toastSuccess = (m,ms=2400)=> toast(m,{type:'success',duration:ms});
const toastInfo    = (m,ms=2600)=> toast(m,{type:'info',duration:ms});
const toastWarn    = (m,ms=3200)=> toast(m,{type:'warn',duration:ms});
const toastError   = (m,ms=3600)=> toast(m,{type:'error',duration:ms});
</script>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  function centerToast(msg){ toast(msg,{type:'info'}); } // ç›¸å®¹èˆŠå‘¼å«

  // ç©å®¶
  function loadName(){ return localStorage.getItem('esg.player')||'Player'; }
  function saveName(v){ localStorage.setItem('esg.player', v); }
  let playerName=loadName(); $('player').textContent=playerName;

  // é›£åº¦
  const DIFF={ easy:{goalMul:.85,timePlus:10,spawnMul:1.15}, normal:{goalMul:1,timePlus:0,spawnMul:1}, hard:{goalMul:1.25,timePlus:-5,spawnMul:.85} };
  let diff=localStorage.getItem('esg.diff')||'normal'; $('difficulty').value=diff;
  $('difficulty').addEventListener('change',()=>{ diff=$('difficulty').value; localStorage.setItem('esg.diff',diff); toastInfo('é›£åº¦è®Šæ›´'); if(running){ startLevel(LV); } });

  // è²éŸ³èˆ‡éŸ³æ¨‚
  let actx=null; try{actx=new (window.AudioContext||window.webkitAudioContext)()}catch(e){actx=null}
  ;['pointerdown','keydown','touchstart'].forEach(ev=>addEventListener(ev,()=>{ if(actx&&actx.state==='suspended'){try{actx.resume()}catch(e){}} },{passive:true}));
  let soundOn=false; function blip(f=720,d=.12){ if(!soundOn||!actx) return; const o=actx.createOscillator(), g=actx.createGain(); o.type='triangle'; o.frequency.value=f; g.gain.value=.0001; o.connect(g).connect(actx.destination); o.start(); const t=actx.currentTime; g.gain.exponentialRampToValueAtTime(.14,t+.02); g.gain.exponentialRampToValueAtTime(.00001,t+d); o.stop(t+d+.02) }
  const music={
    forest:{tempo:108,type:'triangle',vol:.2,steps:[[440,660],[0],[523],[0],[392,784],[0],[523],[0]]},
    city:{tempo:120,type:'sawtooth',vol:.2,steps:[[330],[0],[392],[0],[494],[0],[392],[0]]},
    ocean:{tempo:96,type:'sine',vol:.18,steps:[[294],[0],[330],[0],[392],[0],[330],[0]]},
    boss:{tempo:136,type:'square',vol:.25,steps:[[196,392],[0],[220,440],[0],[247,494],[0],[220,440],[0]]},
    rock:{tempo:132,type:'square',vol:.28,steps:[[329.63,659.25],[0],[392],[0],[329.63,392],[0],[440],[0]]}
  };
  let musicMode=localStorage.getItem('esg.music')||'auto';
  let vol=(+localStorage.getItem('esg.vol')||60)/100;
  let musicBus=actx?actx.createGain():null; if(musicBus&&actx){ musicBus.gain.value=vol; musicBus.connect(actx.destination); }
  let seqTimer=null, seqBeat=.5, seqStep=0;
  function fadeTo(target=vol,secs=.5){ if(!actx||!musicBus) return; const now=actx.currentTime; try{musicBus.gain.cancelScheduledValues(now)}catch(e){} musicBus.gain.setValueAtTime(musicBus.gain.value,now); musicBus.gain.linearRampToValueAtTime(Math.max(0,Math.min(1,target)), now+secs); }
  function stopSeq(){ if(seqTimer){clearInterval(seqTimer);seqTimer=null} fadeTo(0,.3) }
  function playDrums(time,beatLen){
    if(!actx||!musicBus) return;
    const kick = actx.createOscillator(); const kg = actx.createGain();
    kick.type='sine'; kick.frequency.setValueAtTime(120, time); kick.frequency.exponentialRampToValueAtTime(50, time+0.12);
    kg.gain.value=0.0001; kg.gain.exponentialRampToValueAtTime(0.2, time+0.005); kg.gain.exponentialRampToValueAtTime(0.0001, time+0.18);
    kick.connect(kg).connect(musicBus); kick.start(time); kick.stop(time+0.2);
    const sn = actx.createOscillator(); const sg = actx.createGain();
    sn.type='triangle'; sn.frequency.setValueAtTime(220, time+beatLen*0.5); sn.frequency.exponentialRampToValueAtTime(180, time+beatLen*0.5+0.05);
    sg.gain.value=0.0001; sg.gain.exponentialRampToValueAtTime(0.08, time+beatLen*0.5+0.005); sg.gain.exponentialRampToValueAtTime(0.0001, time+beatLen*0.5+0.12);
    sn.connect(sg).connect(musicBus); sn.start(time+beatLen*0.5); sn.stop(time+beatLen*0.65);
  }
  function playTrack(kind){
    if(!actx||!musicBus) return;
    if(kind==='none'){stopSeq();return}
    const p=music[kind]||music.forest;
    stopSeq();
    seqBeat=60/(p.tempo||110);
    seqStep=0;
    seqTimer=setInterval(()=>{
      const t=actx.currentTime;
      const notes=p.steps[seqStep%p.steps.length];
      if(kind==='rock'){ playDrums(t, seqBeat); }
      for(const n of notes){
        if(n){
          const o=actx.createOscillator(), g=actx.createGain();
          o.type=p.type; o.frequency.value=n;
          g.gain.value=.00001;
          o.connect(g).connect(musicBus);
          o.start();
          g.gain.exponentialRampToValueAtTime(p.vol,t+.01);
          g.gain.exponentialRampToValueAtTime(.00001,t+seqBeat*.9);
          o.stop(t+seqBeat);
        }
      }
      seqStep++;
    }, seqBeat*1000);
    fadeTo(vol,.4);
  }
  function applyMusic(bg){
    if(musicMode==='none') return stopSeq();
    if(musicMode==='auto'){
      playTrack(bg==='city'?'city':bg==='ocean'?'ocean':'forest');
    } else {
      playTrack(musicMode);
    }
  }
  // ===== å…¨éƒ¨é‡ç½®ï¼ˆä¿ç•™ç©å®¶åç¨±/åå¥½ï¼‰ =====
function resetProgressRecords(opts={ keepPrefs:true, keepName:true }){
  // è¦æ¸…é™¤çš„ keyï¼ˆé€²åº¦/è³‡æ–™ï¼‰
  const keys = ['esg.bestLV','esg.dex','esg.ach','esg.lb.v54'];

  // é€™äº›æ˜¯ã€Œä»¥æ—¥æœŸç‚ºå‰ç¶´ã€çš„å‹•æ…‹ keyï¼ˆæ¯æ—¥/æ¯é€±ä»»å‹™ã€ä»Šæ—¥å·²å‡ºé¡Œï¼‰
  const prefixes = ['esg.daily.','esg.weekly.','esg.asked.'];

  // è‹¥ä¹Ÿæƒ³æ¸…åå¥½æˆ–åç¨±ï¼Œå°±æŠŠå®ƒå€‘ä¹Ÿæ”¾é€² keys
  if (!opts.keepPrefs){
    keys.push('esg.music','esg.vol','esg.diff','esg.importMode');
  }
  if (!opts.keepName){
    keys.push('esg.player');
  }

  // å…ˆæŠŠæ‰€æœ‰ localStorage key æŠ“å‡ºä¾†ï¼Œé¿å…è¿´åœˆåˆªé™¤æ™‚ length è®Šå‹•
  const allKeys = [];
  for (let i=0; i<localStorage.length; i++){
    allKeys.push(localStorage.key(i));
  }

  // æ¸…é™¤å‰ç¶´é¡
  for (const k of allKeys){
    if (prefixes.some(p => k.startsWith(p))){
      try { localStorage.removeItem(k); } catch(e){}
    }
  }

  // æ¸…é™¤æŒ‡å®š keys
  for (const k of keys){
    try { localStorage.removeItem(k); } catch(e){}
  }

  // ===== é‡ç½®åŸ·è¡ŒæœŸç‹€æ…‹ & é‡æ–°æ¸²æŸ“ =====
  planted = 0; score = 0; combo = 0;
  $('trees').textContent = 0;
  $('score').textContent = 0;
  $('combo').textContent = '0x';
  fill.style.width = '0%';
  hpbar.style.display = 'none';

  // é‚„åŸåœ–é‘‘åˆ°é è¨­ã€åˆ·æ–° UI
  DEX = loadDex();         // æœƒè‡ªå‹•å›åˆ° baseDex()
  renderDex();
  renderLB();
  renderMap();
  updateStats();

  toastSuccess('âœ… å·²é‡ç½®éŠæˆ²ç´€éŒ„ï¼ˆä¿ç•™åç¨±èˆ‡åå¥½ï¼‰');
}

// ç¶å®šæŒ‰éˆ•
$('resetAllBtn')?.addEventListener('click', ()=>{
  if (confirm('ç¢ºå®šè¦é‡ç½®ç´€éŒ„å—ï¼Ÿ\nï¼ˆæœƒæ¸…é™¤é—œå¡é€²åº¦ã€åœ–é‘‘ã€æˆå°±ã€æ’è¡Œæ¦œã€æ¯æ—¥/æ¯é€±ä»»å‹™ã€ä»Šæ—¥æŠ½é¡Œç´€éŒ„ï¼›ä¿ç•™åç¨±/é›£åº¦/éŸ³æ¨‚åå¥½ï¼‰')){
    resetProgressRecords({ keepPrefs:true, keepName:true });
  }
});

/* é€²éšï¼šé•·æŒ‰ 2 ç§’åšã€Œå®Œå…¨é‡ç½®ã€ï¼ˆé€£åç¨±/åå¥½ä¹Ÿæ¸…ï¼‰
$('resetAllBtn')?.addEventListener('mousedown', ()=>{
  this._t = setTimeout(()=>{
    if (confirm('âš ï¸ å®Œå…¨é‡ç½®ï¼šé€£åç¨±èˆ‡åå¥½ä¹Ÿæ¸…é™¤ã€‚è¦ç¹¼çºŒå—ï¼Ÿ')){
      resetProgressRecords({ keepPrefs:false, keepName:false });
      toastWarn('å·²å®Œå…¨é‡ç½®ï¼Œè«‹é‡æ–°è¨­å®šåç¨±èˆ‡åå¥½');
    }
  }, 2000);
});
$('resetAllBtn')?.addEventListener('mouseup', ()=> clearTimeout(this._t));
$('resetAllBtn')?.addEventListener('mouseleave', ()=> clearTimeout(this._t));
*/


  // é—œå¡é…ç½®
  const LEVELS=[
    {goal:120,time:60,spawn:700,quiz:1,bg:'forest',illus:'ğŸŒ²',boss:false},
    {goal:200,time:55,spawn:650,quiz:1,bg:'city',illus:'ğŸ™ï¸',boss:false},
    {goal:280,time:52,spawn:620,quiz:2,bg:'ocean',illus:'ğŸŒŠ',boss:true},
    {goal:360,time:50,spawn:600,quiz:2,bg:'forest',illus:'ğŸ¦Œ',boss:false},
    {goal:460,time:48,spawn:560,quiz:2,bg:'city',illus:'ğŸš‹',boss:true},
    {goal:560,time:46,spawn:520,quiz:3,bg:'ocean',illus:'ğŸŸ',boss:false},
    {goal:680,time:44,spawn:500,quiz:3,bg:'forest',illus:'â›°ï¸',boss:false},
    {goal:820,time:42,spawn:480,quiz:3,bg:'city',illus:'ğŸŒ‰',boss:true},
    {goal:960,time:40,spawn:460,quiz:4,bg:'ocean',illus:'ğŸª¸',boss:false},
    {goal:1120,time:38,spawn:440,quiz:4,bg:'forest',illus:'ğŸ¦…',boss:true}
  ];
  let LV=0; function setBg(kind){ board.classList.remove('bg-forest','bg-city','bg-ocean'); board.classList.add('bg-'+(kind||'forest')); $('illus').textContent=(LEVELS[LV]&&LEVELS[LV].illus)||'ğŸŒ²'; }
  function renderMap(){ const g=$('mapGrid'); g.innerHTML=''; const best=+(localStorage.getItem('esg.bestLV')||1); LEVELS.forEach((cfg,i)=>{ const lock=i+1>best; const n=document.createElement('div'); n.className='node fade-enter'; n.innerHTML='<b>é—œå¡ '+(i+1)+'</b> <span style="opacity:.75">'+cfg.bg+'ï½œç›®æ¨™'+cfg.goal+'ï½œ'+cfg.time+'s '+(cfg.boss?'ï½œBoss':'')+'</span><div style="margin-top:6px;text-align:right"><button class="btn" '+(lock?'disabled':'')+' data-lv="'+i+'">é–‹å§‹</button></div>'; g.appendChild(n); }); g.querySelectorAll('button[data-lv]').forEach(b=>b.addEventListener('click',function(){ $('mapModal').classList.remove('show'); startLevel(+this.dataset.lv); })); }
  function saveBestLV(lv){ const best=+(localStorage.getItem('esg.bestLV')||1); if(lv>best){ localStorage.setItem('esg.bestLV', lv); }}

  const board=$('board'), fill=$('goalFill'), hpbar=$('hpbar'), hpfill=$('hpfill');
  let score=0, combo=0, timeLeft=60, running=false, planted=0, spawnTimer=null, tickTimer=null, bossEl=null, bossHp=0, drainAura=null;
  const EMOJIS=['ğŸ€','ğŸŒ¿','ğŸŒ³','ğŸ’§','âš¡','ğŸŒ'];

  function startLevel(i){ LV=i; const cfg=LEVELS[LV]||LEVELS[0]; const d=DIFF[diff]||DIFF.normal;
    const goal=Math.round(cfg.goal*d.goalMul), time=clamp(cfg.time+d.timePlus,20,999), spawn=Math.round(cfg.spawn*d.spawnMul);
    setBg(cfg.bg); applyMusic(cfg.bg); score=0; combo=0; timeLeft=time; $('level').textContent=(LV+1); $('goal').textContent=goal; $('time').textContent=timeLeft; $('score').textContent=0; $('trees').textContent=planted; fill.style.width='0%'; hpbar.style.display='none';
    if(spawnTimer) clearInterval(spawnTimer); if(tickTimer) clearInterval(tickTimer);
    running=true; spawnTimer=setInterval(spawnToken, spawn); tickTimer=setInterval(()=>{ if(!running) return; timeLeft--; $('time').textContent=timeLeft; if(timeLeft<=0){ gameOver(false); } },1000);
  }
  function spawnToken(){ if(!running) return; const t=document.createElement('div'); t.className='token'; const w=board.clientWidth, h=board.clientHeight; t.style.left=(Math.random()*(w-96)+6)+'px'; t.style.top=(Math.random()*(h-160)+100)+'px'; t.innerHTML='<div class="bubble"><div class="emoji">'+EMOJIS[Math.floor(Math.random()*EMOJIS.length)]+'</div></div>'; t.addEventListener('click',function(){hitToken(t)}); board.appendChild(t); setTimeout(()=>{ t.remove(); }, 3200); }
  function currentGoal(){ return parseInt($('goal').textContent,10)||0; }
  function hitToken(t){ if(!running) return; blip(720,.08); score+=10; combo=Math.min(99,combo+1); $('score').textContent=score; $('combo').textContent=combo+'x'; fill.style.width=Math.min(100,(score/currentGoal())*100)+'%'; t.remove(); if(score>=currentGoal()){ const cfg=LEVELS[LV]; if(cfg.boss && !bossEl){ spawnBoss(); } else { openQuiz(cfg.quiz); } } }
  function openQuiz(n){
  needCorrect = n;
  correctThisRound = 0;
  roundAsked = [];                      // âœ… æ¯è¼ªé–‹å§‹æ¸…ç©º
  $('quizModal').classList.add('show');
  buildTabs();
  renderQuiz();
}

  // =====================
  // ğŸŒ³ åœ–é‘‘ + å­˜æª”
  // =====================
  const TREEDEX_BASE=[
    {name:'å°ç£æ‰',desc:'å›ºç¢³ä½³ï¼Œé‡è‘‰æ¨¹',stage:0,unlocked:true},
    {name:'çƒå¿ƒçŸ³',desc:'æ¨Ÿç§‘ï¼Œè€é™°è€é¢¨',stage:0,unlocked:false},
    {name:'æ¥“é¦™',desc:'ç§‹å­£ç´…è‘‰',stage:0,unlocked:false},
    {name:'æ¦•æ¨¹',desc:'å¸¸ç¶ è¡Œé“æ¨¹',stage:0,unlocked:false},
    {name:'ç›¸æ€æ¨¹',desc:'å›ºæ°®é€ æ—æ¨¹ç¨®',stage:0,unlocked:false},
    {name:'å±±æ¯›æ«¸',desc:'é«˜æµ·æ‹”é—Šè‘‰',stage:0,unlocked:false}
  ];
  function baseDex(){ return JSON.parse(JSON.stringify(TREEDEX_BASE)); }
  function loadDex(){
    try{
      const raw = localStorage.getItem('esg.dex');
      if(!raw) return baseDex();
      const saved = JSON.parse(raw);
      const map = new Map(saved.map(it=>[it.name,it]));
      return baseDex().map(it=>{ const s=map.get(it.name); return s? {...it, ...s} : it; });
    }catch(e){ return baseDex(); }
  }
  function saveDex(dex){ localStorage.setItem('esg.dex', JSON.stringify(dex)); }
  let DEX = loadDex();
  const stageIcon=['ğŸŒ±','ğŸŒ¿','ğŸŒ³'];
  function plantTree(icon){ planted++; $('trees').textContent=planted; const el=document.createElement('div'); el.className='tree'; el.style.setProperty('--x',(Math.random()*(board.clientWidth-80))+'px'); el.textContent=icon||stageIcon[Math.floor(Math.random()*3)]; board.appendChild(el); setTimeout(()=>el.remove(),4800); }
  function renderDex(){ const g=$('dexGrid'); g.innerHTML=''; DEX.forEach(t=>{ const n=document.createElement('div'); n.className='node'; const badge=t.unlocked?'<span style="font-size:12px;background:#dcfce7;padding:2px 8px;border-radius:999px">å·²è§£é–</span>':'<span style="font-size:12px;background:#e5e7eb;padding:2px 8px;border-radius:999px">æœªè§£é–</span>'; const stage=stageIcon[Math.max(0,Math.min(2, t.stage||0))]; n.innerHTML='<b>'+t.name+'</b> '+badge+' <span style="font-size:12px;background:#e2e8f0;padding:2px 8px;border-radius:999px">éšæ®µï¼š'+stage+'</span><p style="margin:6px 0 0;opacity:.9">'+t.desc+'</p>'+(t.unlocked?'<button class="btn" data-plant="1" data-name="'+t.name+'">ç¨®ä¸‹</button>':''); g.appendChild(n); }); g.querySelectorAll('button[data-plant]').forEach(b=>b.addEventListener('click',()=>{ plantTree(); const name=b.getAttribute('data-name'); const t=DEX.find(x=>x.name===name); if(t){ t.stage=Math.min(2,(t.stage||0)+1); saveDex(DEX); renderDex(); } })); }

  $('resetDex').addEventListener('click',()=>{
    if(confirm('ç¢ºå®šè¦é‡ç½®åœ–é‘‘å—ï¼Ÿï¼ˆæ¸…é™¤ esg.dexï¼Œæ¢å¾©åˆå§‹ç‹€æ…‹ï¼‰')){
      localStorage.removeItem('esg.dex');
      DEX = loadDex();
      renderDex();
      toastInfo('åœ–é‘‘å·²é‡ç½®');
    }
  });

  // è‡ªç„¶è§£é–æ¢ä»¶
  function totalCorrect(){ return stats.right||0; }
  function totalTrees(){ return planted||0; }
  function bestLV(){ return +(localStorage.getItem('esg.bestLV')||1); }
  function highScore(){
    try{ const arr=JSON.parse(localStorage.getItem('esg.lb.v54')||'[]'); return arr.reduce((m,r)=>Math.max(m,r.score||0),0); }
    catch(e){return 0;}
  }
  function checkUnlocks(ctx={clear:false,boss:false}){
    let changed=false;
    const ensure=(name)=>{ const t=DEX.find(x=>x.name===name); if(t && !t.unlocked){ t.unlocked=true; changed=true; }}
    if(bestLV()>=2) ensure('çƒå¿ƒçŸ³');
    if(totalCorrect()>=5) ensure('æ¥“é¦™');
    if(score>=300 || highScore()>=600) ensure('æ¦•æ¨¹');
    if(ctx.boss===true) ensure('ç›¸æ€æ¨¹');
    if(totalTrees()>=30) ensure('å±±æ¯›æ«¸');
    if(changed){ saveDex(DEX); renderDex(); toastSuccess('ğŸŒ³ æ–°æ¨¹ç¨®å·²è§£é–ï¼'); }
  }

  // Boss
  function spawnBoss(){ bossHp=120; hpbar.style.display='block'; hpfill.style.width='100%'; bossEl=document.createElement('div'); bossEl.className='boss'; board.appendChild(bossEl); playTrack('boss');
    const tap=function(){ bossHp-=6; blip(180,.07); hpfill.style.width=Math.max(0,bossHp)/120*100+'%'; if(bossHp<=0){ cleanup(true); } };
    board.addEventListener('mousedown',tap); board.addEventListener('touchstart',tap,{passive:true});
    const bossTimer=setInterval(()=>{ if(!bossEl) return; const r=Math.random(); if(r<0.33){ skillShockwave(); } else if(r<0.66){ skillStun(); } else { Math.random()<0.5? skillMissile(): skillDrain(); } }, 2800);
    setTimeout(()=>{ if(bossEl){ cleanup(false,true); } }, 14000);

    function cleanup(kill=false,escape=false){ board.removeEventListener('mousedown',tap); board.removeEventListener('touchstart',tap); clearInterval(bossTimer); if(drainAura&&drainAura.parentNode) drainAura.parentNode.removeChild(drainAura); drainAura=null; if (bossEl) { bossEl.remove(); } bossEl=null; hpbar.style.display='none'; applyMusic(LEVELS[LV].bg); if(kill){ toastSuccess('Boss æ“Šæ•—ï¼'); checkUnlocks({boss:true}); openQuiz(LEVELS[LV].quiz); } else if(escape){ timeLeft=Math.max(0,timeLeft-10); toastWarn('Boss é€ƒèµ°ï¼-10s'); } }
    function skillShockwave(){ const sw=document.createElement('div'); sw.className='shockwave'; board.appendChild(sw); setTimeout(()=>sw.remove(),1200); const lose=30; score=Math.max(0,score-lose); $('score').textContent=score; toastWarn('ğŸ’¥ è¡æ“Šæ³¢ -'+lose+' åˆ†'); }
    function skillStun(){ const old=running; running=false; bossEl.classList.add('aura'); toastInfo('â›” æšˆçœ© 1.5s'); setTimeout(()=>{ running=old; bossEl.classList.remove('aura'); },1500); }
    function skillMissile(){ let m=document.createElement('div'); m.className='missile'; const w=board.clientWidth, h=board.clientHeight; let x=w/2, y=h*0.56; m.style.left=x+'px'; m.style.top=y+'px'; board.appendChild(m); let t0=Date.now(); let timer=setInterval(()=>{ const target=document.querySelector('.token'); if(!target){ m.remove(); clearInterval(timer); return; } const rectT=target.getBoundingClientRect(); const rectB=board.getBoundingClientRect(); const tx=rectT.left-rectB.left+rectT.width/2; const ty=rectT.top-rectB.top+rectB.height/2; x+= (tx-x)*0.12; y+= (ty-y)*0.12; m.style.left=x+'px'; m.style.top=y+'px'; if(Math.hypot(tx-x,ty-y)<18){ const lose=20; score=Math.max(0,score-lose); $('score').textContent=score; toastWarn('ğŸ¯ è¿½è¹¤é£›å½ˆ -'+lose+' åˆ†'); try{target.remove();}catch(e){} clearInterval(timer); m.remove(); } if(Date.now()-t0>3500){ clearInterval(timer); m.remove(); } }, 60); }
    function skillDrain(){ if(drainAura&&drainAura.parentNode) drainAura.parentNode.removeChild(drainAura); drainAura=document.createElement('div'); drainAura.className='drain'; board.appendChild(drainAura); let t=0; const iv=setInterval(()=>{ if(!drainAura||!bossEl){ clearInterval(iv); return; } t++; if(t%4===0){ const lose=5; score=Math.max(0,score-lose); $('score').textContent=score; } },160); setTimeout(()=>{ if(drainAura&&drainAura.parentNode){ drainAura.remove(); drainAura=null; clearInterval(iv); } }, 2200); }
  }

  function gameOver(clear){ running=false; clearInterval(spawnTimer); clearInterval(tickTimer); if(clear){ celebrate(); toastSuccess('ğŸ‰ ç ´é—œï¼'); saveLB(); saveBestLV(LV+2); plantTree('ğŸŒ±'); checkUnlocks({clear:true}); setTimeout(()=>nextLevel(),900); } else { toastInfo('æ™‚é–“åˆ°ï¼Œä¸‹æ¬¡å†ä¾†ï¼'); saveLB(); } }
  function nextLevel(){ if(LV+1>=LEVELS.length){ toastSuccess('ğŸ å…¨é€šé—œï¼'); return; } startLevel(LV+1); }
  function celebrate(){ for(let i=0;i<80;i++){ const c=document.createElement('div'); c.className='confetti'; c.style.left=(Math.random()*100)+'%'; c.style.background='hsl('+(Math.random()*360)+',90%,60%)'; c.style.animationDuration=(1.2+Math.random()*1.4)+'s'; document.body.appendChild(c); setTimeout(()=>c.remove(),2200);} }

  // æˆå°±ï¼ˆç¤ºæ„ï¼‰
  const ACH=[{id:'combo30',name:'é€£æ“Šç‹',desc:'é€£æ“Š â‰¥ 30',check:()=>combo>=30},{id:'planter',name:'ç¨®æ¨¹é”äºº',desc:'ç´¯è¨ˆç¨®æ¨¹ â‰¥ 50',check:()=>planted>=50}];
  function renderAch(){ const g=$('achGrid'); g.innerHTML=''; let owned={}; try{owned=JSON.parse(localStorage.getItem('esg.ach')||'{}')}catch(e){} ACH.forEach(a=>{ const n=document.createElement('div'); n.className='node'; const ok=owned[a.id]; n.innerHTML='<b>'+(ok?'âœ…':'')+' '+a.name+'</b><p style="margin:6px 0 0;opacity:.9">'+a.desc+'</p>'; g.appendChild(n); }); }

  // ===== å•ç­”ï¼ˆQUIZï¼‰ =====
  const CAT=['Energy','Water','Air','Renewable','Carbon']; let weight={Energy:3,Water:2,Air:2,Renewable:3,Carbon:3};
  function buildTabs(){ const box=$('qTabs'); box.innerHTML=''; CAT.forEach(c=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=c; b.dataset.c=c; b.addEventListener('click',()=>{ weight[c]=Math.min(5,(weight[c]||1)+1); updateTabs(); toastInfo(c+' æ¬Šé‡ +1'); }); box.appendChild(b); }); updateTabs(); }
  function updateTabs(){ Array.prototype.forEach.call(document.querySelectorAll('#qTabs .btn'),function(b){ const c=b.dataset.c; const on=(weight[c]||1)>=4; if(on){ b.classList.add('primary'); }else{ b.classList.remove('primary'); } }); updateStats(); }

  // ä½ çš„é¡Œåº«ï¼ˆåŸæœ¬ ans æ¬„ä½ï¼‰ï¼Œç³»çµ±æœƒè‡ªå‹•ç›¸å®¹
  let QUIZ=[
    {cat:'èƒ½æºé¡',q:'å†·æ°£é–‹å¹¾åº¦æœ€å‰›å¥½åˆçœé›»ï¼Ÿ',a:['18Â°C','22Â°C','24â€“26Â°C','30Â°C'],ans:2},
    {cat:'èƒ½æºé¡',q:'ç™½å¤©é–‹å†·æ°£æ™‚ï¼Œè¦æ€éº¼åšæœ€çœé›»ï¼Ÿ',a:['æ‹‰ä¸Šçª—ç°¾','é–‹çª—é€šé¢¨','é–‹é–€æ•£ç†±','èª¿æœ€å¼·é¢¨'],ans:0},
    {cat:'èƒ½æºé¡',q:'å‡ºé–€å‰è¦è¨˜å¾—åšä»€éº¼æœ€çœé›»ï¼Ÿ',a:['é—œç‡ˆ','ç•™è‘—é›»è¦–è²','é–‹å†·æ°£è®“æˆ¿é–“ä¸ç†±','å……æ‰‹æ©Ÿæ•´å¤©'],ans:0},
    {cat:'èƒ½æºé¡',q:'æ›æˆ LED ç‡ˆæ³¡çš„å¥½è™•æ˜¯ä»€éº¼ï¼Ÿ',a:['æ¯”è¼ƒäº®','æ¯”è¼ƒçœé›»','æ¯”è¼ƒè²´','æ¯”è¼ƒå¤§é¡†'],ans:1},
    {cat:'èƒ½æºé¡',q:'å†°ç®±è¦æ€éº¼ç”¨æ‰ä¸æµªè²»é›»ï¼Ÿ',a:['å°‘é–‹å†°ç®±é–€','é–€æ‰“é–‹æ•£ç†±','å¸¸é–‹é—œ','æ”¾ç†±æ¹¯é€²å»'],ans:0},
    {cat:'èƒ½æºé¡',q:'çœ‹å®Œé›»è¦–è¦æ€éº¼åšæœ€çœé›»ï¼Ÿ',a:['æ›é »é“','è®“ç´…ç‡ˆäº®è‘—','éœéŸ³å°±å¥½','é—œé›»æºæˆ–æ‹”æ’é ­'],ans:3},
    {cat:'èƒ½æºé¡',q:'ä¸‹åˆ—å“ªä¸€ç¨®æ˜¯å†ç”Ÿèƒ½æºï¼Ÿ',a:['çŸ³æ²¹','å¤©ç„¶æ°£','å¤ªé™½èƒ½','ç…¤ç‚­'],ans:2},
    {cat:'çœæ°´é¡',q:'åˆ·ç‰™æ™‚è¦æ€éº¼åšæ‰ä¸æµªè²»æ°´ï¼Ÿ',a:['æ°´ä¸€ç›´é–‹è‘—','ç”¨æ¯å­æ¼±å£','é‚Šåˆ·é‚Šç©æ°´','æ²–è¶…ä¹…'],ans:1},
    {cat:'çœæ°´é¡',q:'æ´—è¡£æ©Ÿçš„æ°´å¯ä»¥æ€éº¼å†åˆ©ç”¨ï¼Ÿ',a:['æ¾†èŠ±æˆ–æ‹–åœ°','å€’æ‰','æ´—è»Š','æ²’æœ‰è¾¦æ³•'],ans:2},
    {cat:'çœæ°´é¡',q:'å“ªä¸€å€‹è¡Œç‚ºæœ€æµªè²»æ°´ï¼Ÿ',a:['æ´—ç¢—ç”¨è‡‰ç›†æ¥æ°´','æ¾†èŠ±ç”¨å›æ”¶æ°´','æ²–é¦¬æ¡¶æ¼æ°´ä¸ä¿®','æ´—æ¾¡å¿«æ´—'],ans:2},
    {cat:'çœæ°´é¡',q:'å“ªä¸€å€‹ç”¨æ°´ç¿’æ…£æœ€å¥½ï¼Ÿ',a:['æ²–é¦¬æ¡¶æ¼æ°´ä¸ç†','çœ‹åˆ°æ¼æ°´è¶•å¿«ä¿®','æ´—æ¾¡æ™‚é–“è¶Šé•·è¶Šå¥½','é‚Šç©é‚Šé–‹æ°´'],ans:1},
    {cat:'çœæ°´é¡',q:'æ´—æ¾¡æ™‚è¦çœæ°´ï¼Œå¯ä»¥æ€éº¼åšï¼Ÿ',a:['é–‹æœ€å¤§æ°´é‡è®“æ°´æ¯”è¼ƒå¿«æµå‡º','é‚Šæ´—é‚ŠèŠå¤©','ç¸®çŸ­æ´—æ¾¡æ™‚é–“ã€é—œæ‰ä¸éœ€è¦çš„æ°´æµ','ä¸€ç›´èª¿æ°´æº«ç©'],ans:2},
    {cat:'ç©ºæ°£å“è³ªé¡',q:'PM2.5 æ˜¯ä»€éº¼ï¼Ÿ',a:['æº«åº¦','é¦™æ°£','æ°£é«”','å¾ˆå°çš„ç°å¡µ'],ans:3},
    {cat:'ç©ºæ°£å“è³ªé¡',q:'æƒ³è®“å®¤å…§ç©ºæ°£æ›´å¥½ï¼Œè¦æ€éº¼åšï¼Ÿ',a:['é–‹å…©é‚Šçª—æˆ¶é€šé¢¨','å™´é¦™æ°´','é—œç·Šé–€çª—é–‹å†·æ°£','é–‹é›»é¢¨æ‰‡å¹'],ans:0},
    {cat:'ç©ºæ°£å“è³ªé¡',q:'ç©ºæ°£å“è³ªä¸å¥½çš„æ™‚å€™æ‡‰è©²ï¼Ÿ',a:['å¤šåœ¨å¤–é¢è·‘è·³','æˆ´å£ç½©','é–‹çª—å¸ç©ºæ°£','é»é¦™æ©è“‹å‘³é“'],ans:1},
    {cat:'ç©ºæ°£å“è³ªé¡',q:'å“ªä¸€é …è¡Œç‚ºæœ‰åŠ©æ–¼æ”¹å–„ç©ºæ°£ï¼Ÿ',a:['å°‘é–‹è»Š','æ”¾ç…™ç«','ç‡’åƒåœ¾','å™´é¦™æ°´'],ans:0},
    {cat:'ç©ºæ°£å“è³ªé¡',q:'ç©ºæ°£ä¸­å¤ªå¤šå»¢æ°£æœƒé€ æˆä»€éº¼ï¼Ÿ',a:['å¤©ç©ºæ›´äº®','ç©ºæ°£æ±¡æŸ“','è®Šå†·','åœ°çƒè®Šå¤§'],ans:1},
    {cat:'æ¸›ç¢³é¡',q:'ä¸‹åˆ—å“ªä¸€å€‹è¡Œç‚ºæœ€èƒ½æ¸›å°‘ç¢³æ’æ”¾ï¼Ÿ',a:['å¤©å¤©å«å¤–é€','é–‹è»Šè¼‰è‡ªå·±','é¨æ©Ÿè»Šå…œé¢¨','æ­å…¬è»Š'],ans:3},
    {cat:'æ¸›ç¢³é¡',q:'è²·é£²æ–™æ™‚æ€éº¼åšæœ€æ¸›ç¢³ï¼Ÿ',a:['ç”¨è‡ªå·±çš„ç’°ä¿æ¯','æ¯æ¬¡æ‹¿æ–°æ¯å­','å–å®Œä¸Ÿæ‰','æ‹¿å¸ç®¡å¤šä¸€é»'],ans:0},
    {cat:'æ¸›ç¢³é¡',q:'å“ªä¸€é …è¡Œç‚ºæœ‰åŠ©æ–¼æ¸›ç¢³ï¼Ÿ',a:['å¤šæ­é›»æ¢¯','èµ°æ¨“æ¢¯','é–‹å†·æ°£','é–‹ç‡ˆæ•´å¤©'],ans:1},
    {cat:'æ¸›ç¢³é¡',q:'å“ªä¸€ç¨®é£Ÿç‰©é¸æ“‡æœ€ç’°ä¿ï¼Ÿ',a:['é€²å£æ°´æœ','åœ¨åœ°è”¬èœ','å†·å‡é£Ÿå“','å¤–é€ç‚¸é›'],ans:1},
    {cat:'æ¸›ç¢³é¡',q:'ç‚ºä»€éº¼å°‘åƒç‰›è‚‰å¯ä»¥æ¸›ç¢³ï¼Ÿ',a:['ç‰›åƒå¤ªå¤šè‰','ç‰›æœƒæ”¾å‡ºç”²çƒ·','è‚‰å¤ªè²´','ç‰›å¤ªé‡'],ans:1},
    {cat:'æ¸›ç¢³é¡',q:'ä½•è€…æ˜¯ã€Œè‡ªç„¶ç¢³åŒ¯ã€ä¹‹ä¸€ï¼Ÿ',a:['é›»ç·šæ¡¿','æ±½è»Š','å·¥å» ','æ£®æ—'],ans:3},
    {cat:'æ¸›ç¢³é¡',q:'æ¨¹æœ¨å°åœ°çƒæœ€å¤§çš„å¹«åŠ©æ˜¯ï¼Ÿ',a:['è£½é€ æ°§æ°£','è£é£¾è¡—é“','æ“‹é¢¨','æä¾›æ¨¹è”­'],ans:0},
    {cat:'æ¸›ç¢³é¡',q:'ç¨®æ¨¹èƒ½å¹«åŠ©æ¸›ç¢³ï¼Œæ˜¯å› ç‚ºï¼Ÿ',a:['æ¨¹æœƒè·‘','æ¨¹æœƒè®Šè‰²','æ¨¹æœƒå”±æ­Œ','æ¨¹æœƒå¸äºŒæ°§åŒ–ç¢³'],ans:3},
    {cat:'æ¸›ç¢³é¡',q:'å­¸æ ¡å¯ä»¥æ€éº¼ä¸€èµ·æ¸›ç¢³ï¼Ÿ',a:['ä¸‹èª²é—œç‡ˆ','é›»è…¦æ•´å¤©é–‹è‘—','å†·æ°£18åº¦','ç‡ˆä¸€ç›´äº®'],ans:0},
    {cat:'æ¸›ç¢³é¡',q:'æˆ‘å€‘æ—¥å¸¸ç”Ÿæ´»ä¸­å“ªä¸€é …è¡Œç‚ºæœƒé€ æˆæœ€å¤šç¢³æ’ï¼Ÿ',a:['é–‹å†·æ°£','ç•«ç•«','è®€æ›¸','çœ‹æ›¸'],ans:0},
    {cat:'æº«å®¤æ°£é«”é¡',q:'ä¸‹åˆ—å“ªä¸€ç¨®æ°£é«”æ˜¯ä¸»è¦çš„æº«å®¤æ°£é«”ï¼Ÿ',a:['æ°§æ°£','äºŒæ°§åŒ–ç¢³','æ°«æ°£','æ°¦æ°£'],ans:1},
    {cat:'æº«å®¤æ°£é«”é¡',q:'ç‚ºä»€éº¼åœ°çƒæœƒè¶Šä¾†è¶Šç†±ï¼Ÿ',a:['æº«å®¤æ°£é«”å¤ªå¤šï¼Œç†±æ°£è·‘ä¸å‡ºå»','å¤ªé™½è®Šå¤§äº†','æœˆäº®è®Šè¿‘äº†','ç©ºæ°£è®Šå°‘äº†'],ans:0},
    {cat:'æº«å®¤æ°£é«”é¡',q:'ä¸‹åˆ—å“ªä¸€å€‹å±¬æ–¼ã€Œç”¨åˆ¥äººç™¼çš„é›»ã€ï¼ˆç¯„ç–‡äºŒï¼‰ï¼Ÿ',a:['æ¾†èŠ±','é¨è…³è¸è»Šä¸Šå­¸','æ‹¿å®¶è£¡å›æ”¶ç“¶ç½','é–‹å†·æ°£ã€æ‰“é–‹ç‡ˆ'],ans:3}
  ];

  // âœ… å–æ­£ç¢ºç­”æ¡ˆ indexï¼ˆç›¸å®¹ it.i æˆ– it.ansï¼‰
  function getCorrectIndex(it){
    if (typeof it.i === 'number') return it.i;
    if (typeof it.ans === 'number') return it.ans;
    return 0;
  }

  let stats={right:0,wrong:0};
  // âœ… åé‡è¤‡æŠ½é¡Œï¼šæœ¬è¼ªèˆ‡ä»Šå¤©ï¼ˆè·¨å¤šè¼ªï¼‰
let roundAsked = []; // ç•¶æ¬¡ openQuiz() æœŸé–“çš„å·²å‡ºé¡Œç´¢å¼•

function loadAskedGlobal(){
  try{
    const raw = localStorage.getItem('esg.asked.' + todayKey()); // ä½ ä¸‹æ–¹å·²å®šç¾© todayKey()ï¼Œå‡½å¼å®£å‘Šå¯æå‰ä½¿ç”¨
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? new Set(arr) : new Set();
  }catch(e){ return new Set(); }
}
function saveAskedGlobal(set){
  try{
    localStorage.setItem('esg.asked.' + todayKey(), JSON.stringify(Array.from(set)));
  }catch(e){}
}
let askedGlobal = loadAskedGlobal();  // è¨˜éŒ„ä»Šå¤©å·²å‡ºéé¡Œç›®çš„ç´¢å¼•ï¼ˆSetï¼‰

  function updateStats(){ $('statTotal').textContent=QUIZ.length; $('statRight').textContent=stats.right; $('statWrong').textContent=stats.wrong; const t=stats.right+stats.wrong; $('statAcc').textContent=t?Math.round(stats.right/t*100)+'%':'0%'; }

  // ğŸ” åŒ¯å…¥æ¨¡å¼ï¼ˆåˆä½µï¼è¦†è“‹ï¼‰
  let importMode = localStorage.getItem('esg.importMode') || 'merge'; // 'merge' | 'overwrite'
  const modeBtn = $('importModeBtn');
  function renderImportMode(){
    if (!modeBtn) return;
    modeBtn.textContent = importMode === 'merge' ? 'åˆä½µ' : 'è¦†è“‹';
    modeBtn.classList.toggle('merge', importMode==='merge');
    modeBtn.classList.toggle('over', importMode==='overwrite');
  }
  renderImportMode();
  modeBtn && modeBtn.addEventListener('click', ()=>{
    importMode = (importMode==='merge') ? 'overwrite' : 'merge';
    localStorage.setItem('esg.importMode', importMode);
    renderImportMode();
    toastInfo('CSV åŒ¯å…¥æ¨¡å¼ï¼š<b>'+ (importMode==='merge'?'åˆä½µ':'è¦†è“‹') +'</b>');
  });

  // CSV åŒ¯å…¥ï¼šæ”¯æ´åˆä½µï¼è¦†è“‹ï¼‹i/ans ç›¸å®¹
  function csvToQuiz(text){
    const lines=text.split(/\r?\n/).filter(x=>x.trim());
    let add=0, skip=0;
    if (importMode==='overwrite') {
      QUIZ = [];
    }
    for(let idx=0; idx<lines.length; idx++){
      const L = lines[idx];
      const parts = [];
      // å…è¨±å¸¶å¼•è™Ÿçš„ CSVï¼šç°¡æ˜“ parseï¼ˆé€—è™Ÿåˆ†éš”ï¼Œé›™å¼•è™ŸåŒ…ï¼‰
      let cur='', inQ=false;
      for (let i=0;i<L.length;i++){
        const ch=L[i], nx=L[i+1];
        if (ch === '"' ){ inQ = !inQ; continue; }
        if (ch === ',' && !inQ){ parts.push(cur); cur=''; continue; }
        cur += ch;
      }
      parts.push(cur);
      if(parts.length < 4){ skip++; continue; }
      const cat = parts[0];
      const q   = parts[1];
      const aStr= parts[2];
      const iStr= parts[3];
      const why = parts[4] || '';
      const a = String(aStr).split('|').map(s=>String(s).trim());
      const i = parseInt(iStr,10);
      if (!a.length || isNaN(i)){ skip++; continue; }
      QUIZ.push({cat:String(cat).trim(), q:String(q).trim(), a, i, why:String(why).trim()});
      add++;
    }
    updateStats();
    if (importMode==='overwrite'){
      toastError('ğŸ§¹ <b style="color:#fecaca">è¦†è“‹æ¨¡å¼</b>ï½œé¡Œåº«å·²é‡ç½®ï¼ŒåŒ¯å…¥ '+add+' é¡Œï¼Œç•¥é '+skip+' è¡Œ', 4200);
    }else{
      toastSuccess('ğŸŒ± <b style="color:#bbf7d0">åˆä½µæ¨¡å¼</b>ï½œæ–°å¢ '+add+' é¡Œï¼Œç•¥é '+skip+' è¡Œ', 3800);
    }
  }

  function quizToCsv(){
    const esc = (s)=> String(s==null?'':s).replace(/"/g,'""');
    return QUIZ.map(function(it){
      const _i = getCorrectIndex(it);
      const why = '"'+esc(it.why||'')+'"';
      return [it.cat, it.q, (it.a||[]).join('|'), _i, why].join(',');
    }).join('\n');
  }

  let needCorrect=1, correctThisRound=0, qIndex=-1;
  function openQuiz(n){ needCorrect=n; correctThisRound=0; $('quizModal').classList.add('show'); buildTabs(); renderQuiz(); }
  function pickQuestion(){ const bag=[]; for(let i=0;i<QUIZ.length;i++){ const w=weight[QUIZ[i].cat]||1; for(let k=0;k<w;k++) bag.push(i); } return bag[Math.floor(Math.random()*bag.length)]||0; }
  function renderQuiz(){
  qIndex = pickQuestion();
  const it = QUIZ[qIndex];
  const box = $('quizBox');

  let opts = '';
  for(let idx=0; idx<it.a.length; idx++){
    opts += '<label style="display:block;margin:6px 0"><input type="radio" name="q" value="'+idx+'"> '+it.a[idx]+'</label>';
  }

  box.innerHTML = '<div class="node"><b>['+(it.cat||'')+'] '+it.q+'</b>'+opts+
    '<div style="margin-top:8px"><button class="btn" id="submitQ">æäº¤</button></div>'+
    '<div id="qFeedback" style="margin-top:6px;font-weight:900"></div></div>';

  // âœ… ç™»è¨˜åˆ°æœ¬è¼ªå·²å•ï¼Œé¿å…ã€Œä¸‹ä¸€é¡Œã€åˆæŠ½å›ä¾†
  if(!roundAsked.includes(qIndex)) roundAsked.push(qIndex);

  $('submitQ').addEventListener('click', checkQ);
  updateStats();
}

  function checkQ(){
  const it = QUIZ[qIndex];
  const sel = document.querySelector('input[name="q"]:checked');
  if(!sel) return;

  const correct = getCorrectIndex(it);
  if(+sel.value === correct){
    blip(860,.12);
    $('qFeedback').textContent = 'âœ… ç­”å°äº†ï¼' + (it.why ? (' ' + it.why) : '');
    stats.right++;
    checkUnlocks();
    correctThisRound++;
    plantTree('ğŸŒ¿');

    // âœ… è¨˜éŒ„ä»Šå¤©å·²å•ï¼Œé¿å…æœ¬æ—¥é‡è¤‡
    askedGlobal.add(qIndex);
    saveAskedGlobal(askedGlobal);

    if(correctThisRound >= needCorrect){
      $('quizModal').classList.remove('show');
      gameOver(true);
    } else {
      renderQuiz(); // å†æŠ½ä¸€é¡Œï¼ˆæœƒé¿é–‹ roundAsked æ—¢æœ‰é¡Œï¼‰
    }
  } else {
    blip(200,.12);
    $('qFeedback').textContent = 'âŒ å†æƒ³æƒ³ï½ ' + (it.why || '');
    stats.wrong++;
  }
  updateStats();
}

  $('nextQ').addEventListener('click',renderQuiz);
  $('importCsv').addEventListener('click',()=>{ const f=$('csvQ').files&&$('csvQ').files[0]; if(!f) return alert('è«‹å…ˆé¸æ“‡ .csv'); const fr=new FileReader(); fr.onload=e=>csvToQuiz(String((e.target&&e.target.result)||'')); fr.readAsText(f,'utf-8'); });
  $('exportCsv').addEventListener('click',()=>{ const blob=new Blob([quizToCsv()],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz_export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); });

  // Facts
  const FACTS=['å†·æ°£æ¯é«˜ 1Â°C ç´„çœ 6% é›»','å¾…æ©Ÿé›»åŠ›ä½”å®¶æˆ¶ 5â€“10%','LED å¯çœ 50% é›»','å¤§çœ¾é‹è¼¸èƒ½é™ä½äººå‡æ’æ”¾','PM2.5 ç›´å¾‘å°æ–¼ 2.5Î¼m','GHG å…­é¡ï¼šCOâ‚‚ã€CHâ‚„ã€Nâ‚‚Oã€HFCsã€PFCsã€SFâ‚†','S2ï¼šè³¼å…¥é›»/ç†±/å†·é€ æˆçš„é–“æ¥æ’æ”¾'];
  function renderFacts(){ const ul=$('factsList'); ul.innerHTML=''; for(let i=0;i<FACTS.length;i++){ const li=document.createElement('li'); li.textContent=FACTS[i]; ul.appendChild(li); } }

  // Leaderboardï¼ˆæœ¬æ©Ÿ + æ¸…ç©ºï¼‰
  function saveLB(){ const raw=localStorage.getItem('esg.lb.v54')||'[]'; let arr=[]; try{arr=JSON.parse(raw)}catch(e){} arr.push({name:localStorage.getItem('esg.player')||'Player', lv:LV+1, score:score, trees:planted, ts:Date.now()}); arr.sort((a,b)=> b.score-a.score); arr=arr.slice(0,50); localStorage.setItem('esg.lb.v54', JSON.stringify(arr)); }
  function renderLB(){ const raw=localStorage.getItem('esg.lb.v54')||'[]'; let arr=[]; try{arr=JSON.parse(raw)}catch(e){} const tb=$('lbBody'); tb.innerHTML=''; for(let i=0;i<arr.length;i++){ const r=arr[i]; const tr=document.createElement('tr'); const dt=new Date(r.ts); tr.innerHTML='<td>'+(i+1)+'</td><td>'+r.name+'</td><td>'+r.lv+'</td><td>'+r.score+'</td><td>'+r.trees+'</td><td>'+dt.toLocaleDateString()+'</td>'; tb.appendChild(tr); } }
  async function pushOnline(){ const fb=$('firebaseUrl').value.trim(); const gs=$('sheetsUrl').value.trim(); const data=localStorage.getItem('esg.lb.v54')||'[]'; if(fb){ try{ await fetch(fb,{method:'POST',headers:{'Content-Type':'application/json'},body:data}); toastSuccess('Firebase å·²ä¸Šå‚³'); }catch(e){ alert('Firebase ä¸Šå‚³å¤±æ•—ï¼š'+e.message); } } if(gs){ try{ await fetch(gs,{method:'POST',headers:{'Content-Type':'application/json'},body:data}); toastSuccess('Sheets å·²ä¸Šå‚³'); }catch(e){ alert('Sheets ä¸Šå‚³å¤±æ•—ï¼š'+e.message); } } if(!fb&&!gs){ alert('è«‹è¼¸å…¥ Firebase æˆ– Sheets ç«¯é»'); } }
  async function pullOnline(){ const fb=$('firebaseUrl').value.trim(); const gs=$('sheetsUrl').value.trim(); try{ if(fb){ const r=await fetch(fb); const a=await r.json(); localStorage.setItem('esg.lb.v54', JSON.stringify(a)); } else if(gs){ const r=await fetch(gs); const a=await r.json(); localStorage.setItem('esg.lb.v54', JSON.stringify(a)); } else { return alert('è«‹è¼¸å…¥ç«¯é»'); } renderLB(); toastInfo('å·²æ›´æ–°'); }catch(e){ alert('æ›´æ–°å¤±æ•—ï¼š'+e.message); } }

  // GHG ä»»å‹™æ¸…å–®ï¼ˆS1/S2/S3ï¼‰
  const GHG=[{s:'S1 ç›´æ¥æ’æ”¾', items:['é‹çˆ/ç™¼é›»æ©Ÿç‡ƒæ–™ç´€éŒ„','è£½ç¨‹é€¸æ•£æ’æ”¾è¨˜éŒ„','å†·åª’è£œå……é‡'], hint:'å…¬å¸ç›´æ¥ç‡ƒç‡’ / è£½ç¨‹ / å†·åª’'},
             {s:'S2 è³¼å…¥èƒ½æºé–“æ¥', items:['é›»è²»å¸³å–®ï¼ˆæœˆï¼‰','è’¸æ±½/å†·/ç†±è³¼è²·é‡','å†ç”Ÿèƒ½æºæ†‘è­‰'], hint:'å¤–è³¼é›»/ç†±/å†·çš„é–“æ¥æ’æ”¾'},
             {s:'S3 å…¶ä»–é–“æ¥', items:['é€šå‹¤/å·®æ—…é‡Œç¨‹','ä¸Š/ä¸‹æ¸¸é‹è¼¸','å»¢æ£„ç‰©è™•ç†','è³‡æœ¬è²¡'], hint:'åƒ¹å€¼éˆä¸Šä¸‹æ¸¸æ´»å‹•'}];
  function renderGHG(){ const tb=$('ghgBody'); tb.innerHTML=''; for(let g=0; g<GHG.length; g++){ const x=GHG[g]; const tr=document.createElement('tr'); const items=x.items.map(function(s){return '<label class="node" style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="ghg"> <span>'+s+'</span></label>';}).join(''); tr.innerHTML='<td style="width:180px;vertical-align:top"><b>'+x.s+'</b><div style="opacity:.75">'+x.hint+'</div></td><td style="vertical-align:top"><div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:6px">'+items+'</div></td>'; tb.appendChild(tr); } }

  // ä»»å‹™ï¼ˆæ¯æ—¥/æ¯é€±ï¼‰
  function genDailyTasks(){ return [
    {id:'dq1',text:'å®Œæˆ 1 æ¬¡é—œå¡',need:1},
    {id:'dq2',text:'ç­”å° 3 é¡Œå°çŸ¥è­˜',need:3},
    {id:'dq3',text:'ç¨®ä¸‹ 3 æ£µæ¨¹',need:3}
  ]; }
  function genWeeklyTasks(){ return [
    {id:'wq1',text:'ç´¯ç© 5 æ¬¡é€šé—œ',need:5},
    {id:'wq2',text:'ç´¯ç© 20 é¡Œç­”å°',need:20},
    {id:'wq3',text:'ç´¯ç© 1000 åˆ†',need:1000},
    {id:'wq4',text:'ç¨®ä¸‹ 30 æ£µæ¨¹',need:30},
    {id:'wq5',text:'å®Œæˆ 5 é … GHG æ¸…å–®å‹¾é¸',need:5}
  ]; }
  function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function weekKey(){ const d=new Date(); const base=new Date(d.getFullYear(),0,1); const wk=Math.ceil((((d-base)/86400000)+base.getDay()+1)/7); return d.getFullYear()+'-W'+wk; }
  function ensureTasks(){ const dk='esg.daily.'+todayKey(), wk='esg.weekly.'+weekKey(); if(!localStorage.getItem(dk)){ localStorage.setItem(dk, JSON.stringify({tasks:genDailyTasks(),done:{}})); } if(!localStorage.getItem(wk)){ localStorage.setItem(wk, JSON.stringify({tasks:genWeeklyTasks(),done:{}})); } }
  function taskLi(t,scope){ const done=(scope.done[t.id]); return '<li><div class="todo-top"><label><input type="checkbox" data-scope="'+scope.key+'" data-id="'+t.id+'" '+(done?'checked':'')+'> '+t.text+'</label><span class="todo-badge">'+(scope.key==='D'?'ä»Šæ—¥':'æœ¬é€±')+'</span></div><div class="todo-bar"><div class="todo-fill" style="width:'+(done?100:0)+'%"></div></div></li>'; }
  function renderTasks(){ ensureTasks(); const dk='esg.daily.'+todayKey(), wk='esg.weekly.'+weekKey(); const D=JSON.parse(localStorage.getItem(dk)); const W=JSON.parse(localStorage.getItem(wk)); const ulD=$('dailyList'), ulW=$('weeklyList'); if(ulD){ ulD.innerHTML=D.tasks.map(function(t){return taskLi(t,{key:'D',done:D.done})}).join(''); } if(ulW){ ulW.innerHTML=W.tasks.map(function(t){return taskLi(t,{key:'W',done:W.done})}).join(''); }
    Array.prototype.forEach.call(document.querySelectorAll('#questModal input[type="checkbox"]'),function(cb){ cb.addEventListener('change',onTaskToggle); }); }
  function onTaskToggle(e){ ensureTasks(); const key=e.target.getAttribute('data-scope'); const id=e.target.getAttribute('data-id'); const store=(key==='D'?'esg.daily.'+todayKey():'esg.weekly.'+weekKey()); const data=JSON.parse(localStorage.getItem(store)); data.done[id]=e.target.checked; localStorage.setItem(store, JSON.stringify(data));
    const li=e.target.closest('li'); if(li){ const fill=li.querySelector('.todo-fill'); if(fill) fill.style.width=e.target.checked?'100%':'0%'; } }

  // å–å / ç¶å®š
  function ensureName(){ if(!localStorage.getItem('esg.player')){ $('nameModal').classList.add('show'); } }
  $('nameBtn').addEventListener('click',()=>{ $('nameInput').value = loadName(); $('nameModal').classList.add('show'); });
  $('saveName').addEventListener('click',()=>{ const v=$('nameInput').value.trim()||'Player'; saveName(v); $('player').textContent=v; $('nameModal').classList.remove('show'); toastSuccess('åç¨±å·²æ›´æ–°'); });
  $('resetName').addEventListener('click',()=>{ if(confirm('ç¢ºå®šè¦æŠŠåç¨±é‡ç½®ç‚ºã€ŒPlayerã€å—ï¼Ÿ')){ saveName('Player'); $('player').textContent='Player'; toastInfo('åç¨±å·²é‡ç½®'); } });

  $('soundBtn').addEventListener('click',()=>{ soundOn=!soundOn; $('soundBtn').textContent=soundOn?'ğŸ”Š':'ğŸ”ˆ'; if(soundOn) blip(640,.1) });

  // é–‹å§‹/æš«åœ
  $('startBtn').addEventListener('click',()=>{ ensureName(); planted=0; $('trees').textContent=0; startLevel(0); });
  $('pauseBtn').addEventListener('click',()=>{ running=false; clearInterval(spawnTimer); clearInterval(tickTimer); toastInfo('å·²æš«åœ'); });

  // Modal ç¶å®š
  $('mapBtn').addEventListener('click',()=>{ renderMap(); $('mapModal').classList.add('show'); });
  $('resetProgress').addEventListener('click',()=>{ localStorage.setItem('esg.bestLV',1); toastInfo('é€²åº¦å·²é‡ç½®'); renderMap(); });
  $('treeBtn').addEventListener('click',()=>{ renderDex(); $('treeModal').classList.add('show');
    const header = document.querySelector('#treeModal h3');
    if(header){ let pressTimer=null; const down=()=>{ pressTimer=setTimeout(()=>{ DEX.forEach(t=>{ t.unlocked=true; t.stage=2; }); saveDex(DEX); renderDex(); toastSuccess('ğŸ”“ å·²è§£é–å…¨éƒ¨æ¨¹ç¨®ï¼'); },2000); }; const up=()=>{ clearTimeout(pressTimer); };
      header.addEventListener('mousedown',down); header.addEventListener('touchstart',down,{passive:true});
      header.addEventListener('mouseup',up); header.addEventListener('mouseleave',up); header.addEventListener('touchend',up); }
  });
  $('factsBtn').addEventListener('click',()=>{ renderFacts(); $('factsModal').classList.add('show'); });
  $('achBtn').addEventListener('click',()=>{ renderAch(); $('achModal').classList.add('show'); });
  $('lbBtn').addEventListener('click',()=>{ renderLB(); $('lbModal').classList.add('show'); });
  $('clearLB').addEventListener('click',()=>{
    if(confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬æ©Ÿæ’è¡Œæ¦œå—ï¼Ÿï¼ˆåƒ…æ¸…é™¤ localStorage: esg.lb.v54ï¼‰')){
      localStorage.removeItem('esg.lb.v54');
      renderLB();
      toastInfo('æ’è¡Œæ¦œå·²æ¸…ç©º');
    }
  });
  $('pushOnline').addEventListener('click',pushOnline); $('pullOnline').addEventListener('click',pullOnline);

  // ç›´æ¥é–‹å•Ÿå°çŸ¥è­˜æŒ‰éˆ•
  $('quizBtn').addEventListener('click',()=>{ openQuiz(1); });

  // ä»»å‹™ä¸­å¿ƒ
  $('questBtn').addEventListener('click',()=>{ renderTasks(); renderGHG(); $('questModal').classList.add('show'); bindQuestPager(); showQuestPage(0); });

  // é—œé–‰æŒ‰éˆ•
  Array.prototype.forEach.call(document.querySelectorAll('[data-close]'), function(b){
    b.addEventListener('click',function(){ const id=b.getAttribute('data-close'); $(id).classList.remove('show'); });
  });

  // Music modal
  $('musicBtn').addEventListener('click',()=>{ $('musicSel').value=musicMode; $('vol').value=Math.round(vol*100); $('musicModal').classList.add('show'); });
  $('musicPreview').addEventListener('click',()=>{ const sel=$('musicSel').value; if(sel==='none') stopSeq(); else playTrack(sel==='auto'?'forest':sel); });
  $('musicSave').addEventListener('click',()=>{ musicMode=$('musicSel').value; localStorage.setItem('esg.music',musicMode); vol=(+$('vol').value)/100; localStorage.setItem('esg.vol',Math.round(vol*100)); if(musicBus) musicBus.gain.value=vol; $('musicModal').classList.remove('show'); applyMusic((LEVELS[LV]&&LEVELS[LV].bg)||'forest'); });

  // ä»»å‹™ Pager
  let questPage=0;
  function questPageCount(){ return document.querySelectorAll('#questTrack .pager-page').length; }
  function showQuestPage(i){
    const max = questPageCount() - 1;
    questPage = Math.max(0, Math.min(max, i));
    const track=$('questTrack');
    if(track){ track.style.transform='translateX(-'+(questPage*100)+'%)'; }
    const dots=$('questDots');
    if(dots){
      dots.innerHTML='';
      for(let k=0;k<questPageCount();k++){
        const d=document.createElement('div');
        d.className='pager-dot'+(k===questPage?' active':'');
        d.addEventListener('click',(()=>{ const idx=k; return ()=>showQuestPage(idx); })());
        dots.appendChild(d);
      }
    }
  }
  function bindQuestPager(){
    $('questPrev') && $('questPrev').addEventListener('click',()=>showQuestPage(questPage-1));
    $('questNext') && $('questNext').addEventListener('click',()=>showQuestPage(questPage+1));
    const pager=$('questPager'); let sx=0,dx=0;
    pager && pager.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;dx=0;},{passive:true});
    pager && pager.addEventListener('touchmove',e=>{dx=e.touches[0].clientX-sx;},{passive:true});
    pager && pager.addEventListener('touchend',()=>{ if(Math.abs(dx)>50){ showQuestPage(questPage+(dx<0?1:-1)); } });
  }

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded',()=>{ renderDex(); renderFacts(); renderMap();
    if(location.hash==='#unlockAll'){
      DEX.forEach(t=>{ t.unlocked=true; t.stage=2; });
      saveDex(DEX);
    }
  });
})();
</script>

<!-- âœ… PWA: register SW -->
<!-- âœ… SW register: æ”¯æ´ GitHub Pages å­è·¯å¾‘ -->
<script>
if ('serviceWorker' in navigator && location.protocol.startsWith('http')) {
  window.addEventListener('load', () => {
    // basePath ä¾‹å¦‚ï¼š/UDMgame/
    const parts = location.pathname.split('/').filter(Boolean);
    const basePath = parts.length ? `/${parts[0]}/` : '/';
    const swUrl = `${basePath}sw.js`;
    navigator.serviceWorker.register(swUrl, { scope: basePath })
      .then(() => console.log('âœ… Service Worker registered at', swUrl))
      .catch(err => console.warn('SW register failed:', err));
  });
} else {
  console.warn('SW disabled on non-http(s) origin.');
}
</script>


<!-- ğŸ“² PWA å®‰è£é‚è¼¯ -->
<script>
(function(){
  const btn = document.getElementById('installBtn');
  let deferredPrompt = null;

  const isIOS = () => /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = () =>
    window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

  if (isStandalone()) {
    if (btn) btn.style.display = 'none';
    return;
  }

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (btn) btn.style.display = 'inline-block';
  });

  if (isIOS() && btn) {
    btn.style.display = 'inline-block';
  }

  btn && btn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const r = await deferredPrompt.userChoice;
      console.log('PWA install:', r.outcome);
      deferredPrompt = null;
      btn.style.display = 'none';
    } else if (isIOS()) {
      alert('ğŸ“± iOSï¼šè«‹åœ¨ Safari â†’ å…±äº« â†’ åŠ åˆ°ä¸»ç•«é¢');
    } else {
      alert('è«‹åœ¨ç€è¦½å™¨é¸å–®é¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€ã€‚');
    }
  });

  window.addEventListener('appinstalled', () => {
    console.log('âœ… PWA installed');
    if (btn) btn.style.display = 'none';
    alert('å®‰è£å®Œæˆï¼å¾ä¸»ç•«é¢é–‹å•Ÿæ›´é †æš¢ ğŸŒ¿');
  });
})();
</script>

</body>
</html>
