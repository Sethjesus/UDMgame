<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#16a34a" />
  <title>üêæ JP ESG Á¢≥Áõ§Ê®Ç v5.4.3</title>
  <link rel="icon" type="image/jpeg" sizes="32x32" href="https://raw.githubusercontent.com/Sethjesus/Photo/main/UDM%20New%20Logo.jpg?v=3">
  <style>
    :root{ --ink:#0f172a; --panel:#ffffffcc; --shadow:0 10px 24px rgba(0,0,0,.08); --bg:#f7fbff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-rounded,"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,sans-serif;color:var(--ink);
      background:radial-gradient(1200px 800px at 20% -10%, #e6f5ff 0, transparent 60%),radial-gradient(1200px 800px at 120% 0, #ecfff3 0, transparent 60%),var(--bg);
      display:flex;align-items:center;justify-content:center;padding:14px}
    .app{max-width:1240px;width:100%}
    .topbar{display:flex;gap:10px;justify-content:space-between;align-items:center;background:var(--panel);backdrop-filter:blur(10px);border-radius:18px;padding:10px 12px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand img{width:34px;height:34px;border-radius:50%;box-shadow:0 4px 0 #22c55e}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#fff;box-shadow:var(--shadow);font-weight:800}
    .btn{border:none;background:#fff;border-radius:999px;padding:9px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 #e5e7eb}
    .btn:active{transform:translateY(3px);box-shadow:0 2px 0 rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg,#bef264,#86efac);color:#064e3b;box-shadow:0 6px 0 #22c55e}
    .btn.blue{background:linear-gradient(180deg,#bae6fd,#93c5fd);color:#08324a;box-shadow:0 6px 0 #60a5fa}
    .arena{margin-top:12px}
    .board{position:relative;height:min(64vh,620px);min-height:500px;width:100%;border-radius:22px;overflow:hidden;outline:6px solid #fff;border:3px dashed #bbf7d0;box-shadow:var(--shadow)}
    .bg-forest{background:linear-gradient(180deg,#ecfdf5,#e0ffe9)}
    .bg-city{background:linear-gradient(180deg,#eff6ff,#e0f2ff)}
    .bg-ocean{background:linear-gradient(180deg,#e0f2fe,#e0f7fa)}
    .back-illus{position:absolute;right:8px;bottom:6px;font-size:56px;opacity:.25;pointer-events:none}
    .hud{position:absolute;left:10px;top:10px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;z-index:2}
    .hud .tag{border-radius:999px;padding:6px 10px;background:#fff;box-shadow:var(--shadow);font-weight:800}
    .goalbar{position:absolute;left:10px;right:10px;top:46px;height:10px;background:#fff;border-radius:999px;box-shadow:var(--shadow)}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#86efac,#60a5fa);border-radius:999px;transition:width .25s}
    .hpbar{position:absolute;left:10px;right:10px;top:64px;height:12px;background:#fee2e2;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);display:none}
    .hpfill{height:100%;width:100%;background:linear-gradient(90deg,#fecaca,#ef4444)}
    .token{position:absolute;width:84px;height:84px;cursor:pointer}
    .bubble{position:absolute;inset:0;border-radius:22px;background:radial-gradient(circle at 30% 25%, #fff 0 30%, #eafff0 68%);border:3px solid #bbf7d0;box-shadow:0 10px 20px rgba(22,163,74,.18);display:grid;place-items:center;transition:transform .12s}
    .bubble:active{transform:scale(.92)}
    .emoji{font-size:40px;filter:drop-shadow(0 3px 0 rgba(0,0,0,.08))}
    .tree{position:absolute;bottom:6px;left:0;transform:translateX(var(--x,0));font-size:24px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.15))}
    .toast{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;padding:8px 12px;box-shadow:var(--shadow);font-weight:900;opacity:0;z-index:3}
    .toast.show{animation:toast .9s ease both}
    @keyframes toast{0%{opacity:0;transform:translate(-50%,-50%) scale(.9)}14%{opacity:1;transform:translate(-50%,-50%) scale(1)}86%{opacity:1}100%{opacity:0}}
    .boss{position:absolute;width:130px;height:130px;border-radius:50%;left:50%;top:56%;transform:translate(-50%,-50%);background:radial-gradient(circle at 40% 35%, #374151 0 45%, #111827 70%);box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 -8px 20px rgba(255,255,255,.05);display:grid;place-items:center;z-index:1}
    .boss::after{content:"üëÄ";font-size:40px;transform:translateY(-6px)}
    .boss.aura{box-shadow:0 10px 30px rgba(0,0,0,.25),0 0 22px rgba(239,68,68,.6), inset 0 -8px 20px rgba(255,255,255,.05)}
    .shockwave{position:absolute;left:50%;top:56%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;border:3px solid rgba(239,68,68,.8);opacity:.8;animation:boom 1.2s ease-out both;z-index:1}
    @keyframes boom{from{width:20px;height:20px;opacity:.85}to{width:500px;height:500px;opacity:0}}
    .missile{position:absolute;width:18px;height:18px;border-radius:50%;background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,.7);z-index:1}
    .drain{position:absolute;left:50%;top:56%;transform:translate(-50%,-50%);width:190px;height:190px;border-radius:50%;box-shadow:inset 0 0 22px rgba(59,130,246,.55);opacity:.85;animation:pulse 1.2s ease-in-out infinite;z-index:1}
    @keyframes pulse{0%{transform:translate(-50%,-50%) scale(.9)}50%{transform:translate(-50%,-50%) scale(1.05)}100%{transform:translate(-50%,-50%) scale(.9)}}
    .confetti{position:fixed;width:8px;height:14px;top:-10px;left:50%;border-radius:2px;opacity:.9;animation:fall 1.6s linear forwards;z-index:5}
    @keyframes fall{to{transform:translateY(120vh) rotate(540deg);opacity:0}}
    .fade-enter{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:50}
    .modal.show{display:flex}
    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:var(--shadow);width:min(95vw,1040px)}
    .card h3{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
    .node{border:2px dashed #d1fae5;border-radius:12px;padding:10px}
    .tabbar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 10px;overflow-x:auto;white-space:nowrap}

    /* --- Quest Pager --- */
    .pager-wrap{display:flex;flex-direction:column;gap:10px}
    .pager{position:relative;overflow:hidden;border-radius:14px}
    .pager-track{
      display:flex;
      transition:transform .28s ease;
      will-change: transform;
    }
    .pager-page{min-width:100%;padding:10px;box-sizing:border-box}
    .pager-nav{display:flex;gap:8px;align-items:center;justify-content:center}
    .pager-dot{width:8px;height:8px;border-radius:50%;background:#e5e7eb}
    .pager-dot.active{background:#16a34a}
    .pager-btn{border:none;border-radius:10px;padding:6px 10px;background:#fff;box-shadow:0 4px 0 #e5e7eb;cursor:pointer}

    /* ‚úÖ ÂÖ®Ê©´ÂàóÁâà‰ªªÂãôÊ®£ÂºèÔºàÊ©´ÂêëÊç≤ÂãïÔºâ */
    .todo-list{list-style:none;padding:0;margin:8px 0;display:flex;flex-wrap:nowrap;gap:14px;overflow-x:auto;scroll-snap-type:x mandatory}
    .todo-list::-webkit-scrollbar{height:8px}
    .todo-list::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    .todo-list li{flex:0 0 300px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);scroll-snap-align:start;display:flex;flex-direction:column;justify-content:space-between}
    .todo-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .todo-top label{display:flex;align-items:center;gap:10px;font-size:16px;line-height:1.4}
    .todo-badge{font-size:13px;color:#0f172a99;background:#f3f4f6;border-radius:10px;padding:2px 8px;min-width:64px;text-align:center}
    .todo-bar{height:6px;border-radius:6px;background:#f1f5f9;overflow:hidden;margin-top:4px}
    .todo-fill{height:100%;width:0;background:linear-gradient(90deg,#86efac,#60a5fa)}

    /* ‚úÖ GHG 14064 Â∞çÁÖßÊì¥ÂÖÖË°®Ê†º */
    .ghg-table{width:100%;border-collapse:collapse;margin-top:12px;min-width:820px}
    .ghg-table th,.ghg-table td{border:1px solid #d1d5db;padding:6px 10px;text-align:left;vertical-align:top}
    .ghg-table th{background:#f3f4f6}
    .ghg-table caption{caption-side:top;font-weight:700;margin-bottom:8px}

    @media (max-width:680px){ .controls{gap:6px} .chip{padding:6px 10px} .token{width:74px;height:74px} }

    /* ===== Quest ÁâàÈù¢‰∏ÄËá¥Âåñ‰øÆÊ≠£ ===== */
    #questModal .pager-page { padding: 0; }
    #questModal .pager-page > .grid { margin: 0; display:block; }
    #questModal .pager-page > .grid > .node { width: 100%; }

    #questModal .node .node { padding: 0; border: none; box-shadow: none; }

    #questModal .todo-list { padding: 0 8px; margin: 8px 0; }
    #questModal .todo-list li { flex: 0 0 280px; }
    #questModal .todo-top { margin-bottom: 6px; }

    #questModal .ghg-table { min-width: 960px; width: 100%; }
    #questModal .node[style*="overflow:auto"] { max-width: 100%; }

    #questModal .card { max-height: 86vh; overflow: auto; }
    #questModal { overflow-y: auto; }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <img src="https://raw.githubusercontent.com/Sethjesus/Photo/main/UDM%20New%20Logo.jpg?v=3" alt="UDM Logo"/>
      <div style="display:flex;flex-direction:column;line-height:1.1">
        <b id="title">Á¢≥Áõ§Ê®Ç ESG v5.4.3</b>
        <small id="subtitle" style="opacity:.8">UDMÔΩúÈÇäÁé©ÈÇäÂ≠∏</small>
      </div>
    </div>
    <div class="controls">
      <span class="chip">üë§ <b id="player">Player</b></span>
      <span class="chip">ÈóúÂç°Ôºö<b id="level">1</b>/10</span>
      <span class="chip">Èõ£Â∫¶Ôºö
        <select id="difficulty">
          <option value="easy">Á∞°ÂñÆ</option>
          <option value="normal" selected>ÊôÆÈÄö</option>
          <option value="hard">Âõ∞Èõ£</option>
        </select>
      </span>
      <span class="chip" id="scoreChip">ESG ÂàÜÊï∏Ôºö<b id="score">0</b></span>
      <span class="chip"><span id="treesLabel">Â∑≤Á®ÆÊ®πÔºö</span><b id="trees">0</b> Ê£µ</span>
      <button class="btn" id="mapBtn">üó∫Ô∏è Âú∞Âúñ</button>
      <button class="btn" id="treeBtn">üå≥ ÂúñÈëë</button>
      <button class="btn" id="questBtn">üìÖ ‰ªªÂãô</button>
      <button class="btn" id="quizBtn">üß† Â∞èÁü•Ë≠ò</button>
      <button class="btn" id="factsBtn">üìö Áü•Ë≠òÂ∫´</button>
      <button class="btn" id="achBtn">üèÜ ÊàêÂ∞±</button>
      <button class="btn" id="lbBtn">‚≠ê ÊéíË°å</button>
      <button class="btn" id="musicBtn">üéµ Èü≥Ê®Ç</button>
      <button class="btn primary" id="startBtn">ÈñãÂßã</button>
      <button class="btn blue" id="pauseBtn">Êö´ÂÅú</button>
      <button class="btn" id="langBtn" aria-pressed="false">üåê EN</button>
      <button class="btn" id="soundBtn" aria-pressed="false">üîà</button>
    </div>
  </div>

  <div class="arena">
    <div class="board bg-forest" id="board">
      <div class="back-illus" id="illus">üå≤</div>
      <div class="hud">
        <span class="tag">üî• <b id="combo">0x</b></span>
        <span class="tag">‚è± <b id="time">60</b>s</span>
        <span class="tag">üéØ ÁõÆÊ®ôÔºö<b id="goal">120</b></span>
      </div>
      <div class="goalbar"><div class="fill" id="goalFill"></div></div>
      <div class="hpbar" id="hpbar"><div class="hpfill" id="hpfill"></div></div>
    </div>
    <div class="hint" id="versionNote"></div>
  </div>
</div>

<!-- ÂèñÂêç -->
<div class="modal" id="nameModal"><div class="card">
  <h3>ÂèñÂÄãÂêçÂ≠óÂêß</h3>
  <div class="node"><input id="nameInput" placeholder="‰Ω†ÁöÑÂêçÂ≠ó" style="width:100%"></div>
  <div style="text-align:right"><button class="btn primary" id="saveName">ÂÑ≤Â≠ò</button></div>
</div></div>

<!-- Âú∞Âúñ -->
<div class="modal" id="mapModal"><div class="card">
  <h3>üó∫Ô∏è ÈóúÂç°Âú∞Âúñ</h3>
  <div class="grid" id="mapGrid"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="resetProgress">ÈáçÁΩÆÈÄ≤Â∫¶</button><button class="btn" data-close="mapModal">ÈóúÈñâ</button></div>
</div></div>

<!-- ÂúñÈëë -->
<div class="modal" id="treeModal"><div class="card">
  <h3>üå≥ Ê®πÁ®ÆÂúñÈëë</h3>
  <div class="grid" id="dexGrid"></div>
  <div style="text-align:right"><button class="btn" data-close="treeModal">ÈóúÈñâ</button></div>
</div></div>

<!-- ‰ªªÂãô‰∏≠ÂøÉÔºàPager 5 È†ÅÔºâ -->
<div class="modal" id="questModal"><div class="card">
  <h3>üìÖ ‰ªªÂãô‰∏≠ÂøÉ</h3>

  <div class="pager-wrap">
    <div class="pager" id="questPager">
      <div class="pager-track" id="questTrack">
        <!-- 0ÔºöÊØèÊó• -->
        <section class="pager-page">
          <div class="grid">
            <div class="node">
              <b>üéØ ÊØèÊó•‰ªªÂãô</b>
              <ul id="dailyList" class="todo-list"></ul>
            </div>
          </div>
        </section>
        <!-- 1ÔºöÊØèÈÄ± -->
        <section class="pager-page">
          <div class="grid">
            <div class="node">
              <b>üìÜ ÊØèÈÄ±‰ªªÂãô</b>
              <ul id="weeklyList" class="todo-list"></ul>
            </div>
          </div>
        </section>
        <!-- 2ÔºöÊ∏ÖÂñÆÔºàS1/S2/S3Ôºâ -->
        <section class="pager-page">
          <div class="grid">
            <div class="node">
              <b>üìë Á¢≥Áõ§Êü•‰ªªÂãôÊµÅÔºàS1 / S2 / S3Ôºâ</b>
              <table class="table" style="width:100%;border-collapse:separate;border-spacing:0 6px">
                <tbody id="ghgBody"></tbody>
              </table>
            </div>
          </div>
        </section>
        <!-- 3ÔºöGHG / ISO 14064-1 Â∞çÁÖßË°®ÔºàË°®Ê†ºÔºâ -->
        <section class="pager-page">
          <div class="grid">
            <div class="node">
              <b>üßæ GHG / ISO 14064-1 Â∞çÁÖßË°®</b>
              <div class="node" style="overflow:auto">
                <table class="ghg-table">
                  <thead>
                    <tr><th>Áí∞‰øùÁΩ≤Ë¶èÁØÑÁØÑÁñá</th><th>GHG Protocol</th><th>ISO 14064-1:2018</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><b>Áõ§Êü•Ê∫´ÂÆ§Ê∞£È´î</b></td>
                      <td>‰∫¨ÈÉΩË≠∞ÂÆöÊõ∏Ê∂µËìã CO‚ÇÇ„ÄÅCH‚ÇÑ„ÄÅN‚ÇÇO„ÄÅSF‚ÇÜ„ÄÅHFCs„ÄÅPFCs Á≠â 6 È°ûÊ∞£È´îÔºõÂÖ∂‰ªñÊ∞£È´îÂè¶Ë°åÊè≠Èú≤„ÄÇ</td>
                      <td>Â∏∏Áî®Ê∏ÖÂñÆÂê´ CO‚ÇÇ„ÄÅCH‚ÇÑ„ÄÅN‚ÇÇO„ÄÅNF‚ÇÉ„ÄÅSF‚ÇÜ„ÄÅHFCs„ÄÅPFCs Á≠â„ÄÇ</td>
                    </tr>
                    <tr>
                      <td><b>Áõ¥Êé•ÊéíÊîæ</b></td>
                      <td>ÁØÑÁñá 1ÔºöÁõ¥Êé•Ê∫´ÂÆ§Ê∞£È´îÊéíÊîæ</td>
                      <td>È°ûÂà• 1ÔºöÁõ¥Êé•Ê∫´ÂÆ§Ê∞£È´îÊéíÊîæËàáÁßªÈô§</td>
                    </tr>
                    <tr>
                      <td><b>ËÉΩÊ∫êÈñìÊé•ÊéíÊîæ</b></td>
                      <td>ÁØÑÁñá 2ÔºöÈõªÂäõ‰πãÈñìÊé•Ê∫´ÂÆ§Ê∞£È´îÊéíÊîæ</td>
                      <td>È°ûÂà• 2ÔºöÈÄ≤Âè£ËÉΩÊ∫êÁöÑÈñìÊé•Ê∫´ÂÆ§Ê∞£È´îÊéíÊîæ</td>
                    </tr>
                    <tr>
                      <td><b>ÂÖ∂‰ªñÈñìÊé•ÊéíÊîæ</b></td>
                      <td>ÁØÑÁñá 3ÔºöÂÖ∂‰ªñÈñìÊé•ÊéíÊîæÔºà15 È°ûÔºöÊé°Ë≥º„ÄÅË≥áÊú¨Ë≤°„ÄÅÁáÉÊñôËàáËÉΩÊ∫ê‰∏äÊ∏∏„ÄÅÈÅãËº∏ËàáÈÖçÈÄÅ„ÄÅÂª¢Ê£ÑÁâ©„ÄÅÂïÜÊóÖ„ÄÅÈÄöÂã§„ÄÅ‰∏äÊ∏∏ÁßüË≥É„ÄÅ‰∏ãÊ∏∏ÈÅãËº∏ÈÖçÈÄÅ„ÄÅÁî¢ÂìÅÂä†Â∑•„ÄÅÁî¢ÂìÅ‰ΩøÁî®„ÄÅÊúüÊú´ËôïÁΩÆ„ÄÅ‰∏ãÊ∏∏ÁßüË≥É„ÄÅÂä†Áõü„ÄÅÊäïË≥áÔºâ</td>
                      <td>È°ûÂà• 3‚Äì6ÔºöÈÅãËº∏„ÄÅÁî¢ÂìÅ‰ΩøÁî®„ÄÅÁØÑÂúçÂ§ñÈñìÊé•ÊéíÊîæÔºàÊäïË≥á/ÁâπË®±/ÁßüË≥É/Âä†ÁõüÔºâËàáÂÖ∂‰ªñ‰æÜÊ∫êÈñìÊé•ÊéíÊîæ</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
        <!-- 4ÔºöÁõ§Êü•ÂÆöÁæ©ËàáÊáâÁî®Âª∂‰º∏ -->
        <section class="pager-page">
          <div class="grid">
            <div class="node">
              <b>üìò Áõ§Êü•ÂÆöÁæ©ËàáÊáâÁî®Âª∂‰º∏</b>
              <div class="node" style="overflow:auto;margin-top:8px">
                <b>üß≠ ÁµÑÁπîÈÇäÁïåÔºàBoundary DefinitionÔºâ</b>
                <table class="ghg-table">
                  <thead><tr><th>È†ÖÁõÆ</th><th>Ë™™Êòé</th></tr></thead>
                  <tbody>
                    <tr><td>ËÇ°Ê¨äÊ≥ï (Equity Share)</td><td>‰æù‰ºÅÊ•≠Âú®Ë¢´ÊäïË≥áÂñÆ‰Ωç‰πãÊåÅËÇ°ÊØî‰æãË®àÁÆóÊéíÊîæÈáè„ÄÇ</td></tr>
                    <tr><td>Ë≤°ÂãôÊéßÂà∂ (Financial Control)</td><td>‰ºÅÊ•≠ÂÖ∑ÊúâË≤°ÂãôÊ±∫Á≠ñÊ¨äÔºàÈ†êÁÆó/Ë≥áÊú¨ÈÖçÁΩÆÁ≠âÔºâËÄÖÔºåÁ¥çÂÖ•Áõ§Êü•ÈÇäÁïå„ÄÇ</td></tr>
                    <tr><td>ÁáüÈÅãÊéßÂà∂ (Operational Control)</td><td>‰ºÅÊ•≠ËÉΩ‰∏ªÂ∞éÊó•Â∏∏ÁáüÈÅãËàáÊîøÁ≠ñËÄÖÔºåÊáâÁ¥çÂÖ•Áõ§Êü•„ÄÇ</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="node" style="overflow:auto;margin-top:8px">
                <b>üß© ÁáüÈÅãÊéßÂà∂Ê≥ïÊáâÁî®</b>
                <table class="ghg-table">
                  <thead><tr><th>ÂàÜÈ°û</th><th>ÁØÑ‰æã</th><th>ÊòØÂê¶Á¥çÂÖ•Áõ§Êü•</th></tr></thead>
                  <tbody>
                    <tr><td>ÂÖ¨Âè∏Ëá™ÊúâÂª†ÊàøËàáË®≠ÂÇô</td><td>Ëá™ÁáüÁîüÁî¢Á∑ö„ÄÅËæ¶ÂÖ¨ÂÆ§</td><td>‚úÖ ÊòØ</td></tr>
                    <tr><td>ÂßîÂ§ñÂä†Â∑•Âª†</td><td>ÁÑ°Êó•Â∏∏ÁÆ°ÁêÜÊ¨ä</td><td>‚ùå Âê¶ÔºàÂèØÂàóÂÖ• S3Ôºâ</td></tr>
                    <tr><td>ÂêàË≥á‰ºÅÊ•≠</td><td>ÊåÅËÇ°‰ΩÜÁÑ°ÁáüÈÅãÊéßÂà∂Ê¨ä</td><td>‚ûñ ‰æùËÇ°Ê¨äÊ≥ïÊåâÊØî‰æãÂàóÂÖ•</td></tr>
                    <tr><td>ÂßîÂ§ñÁâ©ÊµÅÊàñÁßüË≥É</td><td>Áî±Á¨¨‰∏âÊñπÈÅã‰Ωú</td><td>‚úÖ Ëã•Áî±‰ºÅÊ•≠ÊåáÊèÆÈÅã‰ΩúÂâáÁ¥çÂÖ•</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="node" style="overflow:auto;margin-top:8px">
                <b>üîÑ Á¢≥Áõ§Êü•ÊµÅÁ®ãÔºàCarbon Inventory FlowÔºâ</b>
                <table class="ghg-table">
                  <thead><tr><th>Ê≠•È©ü</th><th>Ë™™Êòé</th></tr></thead>
                  <tbody>
                    <tr><td>1. ÁïåÂÆöÁµÑÁπîËàáÁáüÈÅãÈÇäÁïå</td><td>Á¢∫Ë™çÁõ§Êü•Â∞çË±°ÁØÑÂúçÔºàÂê´Â≠êÂÖ¨Âè∏„ÄÅÂ∑•Âª†„ÄÅËæ¶ÂÖ¨ÂÆ§Ôºâ„ÄÇ</td></tr>
                    <tr><td>2. Ëæ®Ë≠òÊéíÊîæÊ∫ê</td><td>Áõ§ÈªûËÉΩÊ∫ê„ÄÅÁáÉÊñô„ÄÅË®≠ÂÇô„ÄÅÈÅãËº∏„ÄÅÂª¢Ê£ÑÁâ©Á≠â‰æÜÊ∫ê„ÄÇ</td></tr>
                    <tr><td>3. ËíêÈõÜÊ¥ªÂãïÊï∏Êìö</td><td>ÁáÉÊñôÈáè„ÄÅÈõªË°®Â∫¶Êï∏„ÄÅÈáåÁ®ã„ÄÅÂô∏ÂÖ¨Èáå„ÄÅÈáçÈáèÁ≠â„ÄÇ</td></tr>
                    <tr><td>4. Â•óÁî®ÊéíÊîæ‰øÇÊï∏</td><td>ÈÅ∏Áî®ÊîøÂ∫úÊàñÂúãÈöõÊåáÂçóÔºàIPCC„ÄÅEPA„ÄÅDEFRA„ÄÅÂú®Âú∞ÈõªÂäõ‰øÇÊï∏Ôºâ„ÄÇ</td></tr>
                    <tr><td>5. Ë®àÁÆóÊéíÊîæÈáè</td><td>Ê¥ªÂãïÊï∏Êìö √ó ÊéíÊîæ‰øÇÊï∏ÔºàÂøÖË¶ÅÊôÇ‰πò‰ª• GWPÔºâ„ÄÇ</td></tr>
                    <tr><td>6. ÂØ©Êü•ËàáÊü•È©ó</td><td>ÂÖßÈÉ®ÊàñÁ¨¨‰∏âÊñπÂØ©Êü•Ë≥áÊñô‰æÜÊ∫ê„ÄÅÈÇäÁïåËàáË®àÁÆóÈÇèËºØ„ÄÇ</td></tr>
                    <tr><td>7. Êè≠Èú≤ËàáÊîπÂñÑ</td><td>Âπ¥Â∫¶Â†±ÂëäÊè≠Èú≤‰∏¶Ë®≠ÂÆöÊ∏õÁ¢≥ÁõÆÊ®ôËàáË°åÂãï„ÄÇ</td></tr>
                    <tr><td>16+4ËÅØÁπ´ÈõªË©±Á™óÂè£</td><td>Ê∫´Á∂ìÁêÜ: 02-3224-7916„ÄÇ</td></tr>
                     <p>üìç <a href="https://www.idipckeelung.org.tw/%E3%80%90%E8%A3%9C%E5%8A%A9%E8%B3%87%E8%A8%8A%E3%80%91%E5%9B%A0%E6%87%89%E4%B8%AD%E5%B0%8F%E4%BC%81%E6%A5%AD%E9%9C%80%E6%B1%82%EF%BC%8C%E7%94%B3%E8%AB%8B%E6%97%A5%E6%9C%9F%E6%8B%89%E9%95%B7%E8%87%B312/"
           target="_blank" rel="noopener"><b>üëâ ÈªûÊàëÂâçÂæÄÁî≥Ë´ã 16+4 Á¢≥Áõ§Êü•Ë£úÂä©Ë®àÁï´</b></a></p>

                  </tbody>
                </table>
              </div>
              <div class="node" style="overflow:auto;margin-top:8px">
                <b>‚öôÔ∏è ÊéíÊîæ‰øÇÊï∏ÁØÑ‰æãÔºàÁ§∫ÊÑèÔºâ</b>
                <table class="ghg-table">
                  <thead><tr><th>È°ûÂà•</th><th>ÂñÆ‰Ωç</th><th>ÂèÉËÄÉ‰øÇÊï∏ÔºàkgCO‚ÇÇeÔºâ</th><th>Â∏∏Ë¶ã‰æÜÊ∫ê</th></tr></thead>
                  <tbody>
                    <tr><td>ÈõªÂäõÔºàÂè∞ÁÅ£Âú∞ÂçÄÔºâ</td><td>kWh</td><td>0.495</td><td>Áí∞‰øùÁΩ≤/ËÉΩÊ∫êÂ±ÄÂÖ¨Â∏É‰πãÂπ¥Â∫¶‰øÇÊï∏</td></tr>
                    <tr><td>Ê±ΩÊ≤π</td><td>L</td><td>2.27</td><td>IPCC 2006</td></tr>
                    <tr><td>Êü¥Ê≤π</td><td>L</td><td>2.68</td><td>IPCC 2006</td></tr>
                    <tr><td>Â§©ÁÑ∂Ê∞£</td><td>Nm¬≥</td><td>2.05</td><td>ËÉΩÊ∫êÂ±ÄÂõ†Â≠ê</td></tr>
                    <tr><td>Âì°Â∑•ÈÄöÂã§ÔºàÂ∞èÂÆ¢ËªäÔºâ</td><td>km</td><td>0.21</td><td>DEFRA 2023</td></tr>
                    <tr><td>Âª¢Ê£ÑÁâ©Êé©Âüã</td><td>kg</td><td>0.45</td><td>EPA WARM</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
    <div class="pager-nav">
      <button class="pager-btn" id="questPrev">‚óÄ</button>
      <span id="questDots" style="display:flex;gap:6px"></span>
      <button class="pager-btn" id="questNext">‚ñ∂</button>
    </div>
  </div>

  <div style="text-align:right;margin-top:8px">
    <button class="btn" data-close="questModal">ÈóúÈñâ</button>
  </div>
</div></div>

<!-- ÂïèÁ≠î -->
<div class="modal" id="quizModal"><div class="card">
  <h3>üß† Â∞èÁü•Ë≠òÂïèÁ≠î</h3>
  <div class="tabbar" id="qTabs"></div>
  <div class="node" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
    <input type="file" id="csvQ" accept=".csv"><button class="btn" id="importCsv">ÂåØÂÖ• CSV</button>
    <button class="btn" id="exportCsv">ÂåØÂá∫ CSV</button>
    <span style="opacity:.7;font-size:12px">Ê†ºÂºèÔºöcat,q,a1|a2|a3|a4,correct_index,why</span>
  </div>
  <div id="quizStats" class="node" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
    <div>üéØ Á∏ΩÈ°åÊï∏Ôºö<b id="statTotal">0</b></div>
    <div>‚úÖ Á≠îÂ∞çÔºö<b id="statRight">0</b></div>
    <div>‚ùå Á≠îÈåØÔºö<b id="statWrong">0</b></div>
    <div>üìä Ê≠£Á¢∫ÁéáÔºö<b id="statAcc">0%</b></div>
  </div>
  <div id="quizBox"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn" id="nextQ">‰∏ã‰∏ÄÈ°å</button>
    <button class="btn" data-close="quizModal">ÈóúÈñâ</button>
  </div>
</div></div>

<!-- Áü•Ë≠òÂ∫´ -->
<div class="modal" id="factsModal"><div class="card">
  <h3>üìö Áü•Ë≠òÂ∫´</h3>
  <ul id="factsList" style="line-height:1.8"></ul>
  <div style="text-align:right"><button class="btn" data-close="factsModal">ÈóúÈñâ</button></div>
</div></div>

<!-- ÊàêÂ∞± -->
<div class="modal" id="achModal"><div class="card">
  <h3>üèÜ ÊàêÂ∞±</h3>
  <div class="grid" id="achGrid"></div>
  <div style="text-align:right"><button class="btn" data-close="achModal">ÈóúÈñâ</button></div>
</div></div>

<!-- ÊéíË°å -->
<div class="modal" id="lbModal"><div class="card">
  <h3>‚≠ê ÊéíË°åÊ¶ú</h3>
  <table class="table" style="width:100%;border-collapse:separate;border-spacing:0 6px"><thead><tr><th>#</th><th>Áé©ÂÆ∂</th><th>ÈóúÂç°</th><th>ÂàÜÊï∏</th><th>Ê®π</th><th>Êó•Êúü</th></tr></thead><tbody id="lbBody"></tbody></table>
  <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:8px">
    <input id="firebaseUrl" placeholder="Firebase REST URL (ÂèØÈÅ∏)" style="flex:1;min-width:260px">
    <input id="sheetsUrl" placeholder="Google Apps Script ÈÉ®ÁΩ≤Á∂≤ÂùÄ (ÂèØÈÅ∏)" style="flex:1;min-width:260px">
    <button class="btn" id="pushOnline">‰∏äÂÇ≥</button>
    <button class="btn" id="pullOnline">Êõ¥Êñ∞</button>
    <button class="btn" data-close="lbModal">ÈóúÈñâ</button>
  </div>
</div></div>

<!-- Èü≥Ê®Ç -->
<div class="modal" id="musicModal"><div class="card">
  <h3>üéµ Èü≥Ê®ÇËàáÈü≥Èáè</h3>
  <div class="node" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div>
      <b>Êõ≤ÁõÆ</b>
      <select id="musicSel" style="width:100%;margin-top:6px">
        <option value="auto">Ëá™ÂãïËº™Êí≠ÔºàÈö®ÈóúÂç°Ôºâ</option>
        <option value="forest">Ê£ÆÊûóÊõ≤</option>
        <option value="city">ÂüéÂ∏ÇÊõ≤</option>
        <option value="ocean">Êµ∑Ê¥ãÊõ≤</option>
        <option value="boss">Boss Êõ≤</option>
        <option value="none">ÁÑ°Èü≥Ê®Ç</option>
      </select>
    </div>
    <div>
      <b>Èü≥Èáè</b>
      <input id="vol" type="range" min="0" max="100" value="60"/>
      <div style="opacity:.75;font-size:12px">ÊªëÂãïË™øÊï¥Èü≥Èáè</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn" id="musicPreview">Ë©¶ËÅΩ</button>
    <button class="btn primary" id="musicSave">Â•óÁî®</button>
    <button class="btn" data-close="musicModal">ÈóúÈñâ</button>
  </div>
</div></div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  function toast(msg){ const t=document.createElement('div'); t.className='toast show'; t.textContent=msg; board.appendChild(t); setTimeout(()=>t.remove(),1200); }
  function celebrate(){ for(let i=0;i<80;i++){ const c=document.createElement('div'); c.className='confetti'; c.style.left=(Math.random()*100)+'%'; c.style.background='hsl('+(Math.random()*360)+',90%,60%)'; c.style.animationDuration=(1.2+Math.random()*1.4)+'s'; document.body.appendChild(c); setTimeout(()=>c.remove(),2200);} }

  // Ë™ûÁ≥ª
  let LANG=localStorage.getItem('esg.lang')||'zh';
  function applyLang(){ const zh=(LANG==='zh'); $('langBtn').textContent=zh?'üåê EN':'üåê ‰∏≠Êñá'; $('treesLabel').textContent=zh?'Â∑≤Á®ÆÊ®πÔºö':'Trees:'; }

  // Áé©ÂÆ∂
  let playerName=localStorage.getItem('esg.player')||'Player'; $('player').textContent=playerName;

  // Èõ£Â∫¶
  const DIFF={ easy:{goalMul:.85,timePlus:10,spawnMul:1.15}, normal:{goalMul:1,timePlus:0,spawnMul:1}, hard:{goalMul:1.25,timePlus:-5,spawnMul:.85} };
  let diff=localStorage.getItem('esg.diff')||'normal'; $('difficulty').value=diff;
  $('difficulty').addEventListener('change',()=>{ diff=$('difficulty').value; localStorage.setItem('esg.diff',diff); toast('Èõ£Â∫¶ËÆäÊõ¥'); if(running){ startLevel(LV); } });

  // ËÅ≤Èü≥ËàáÈü≥Ê®Ç
  let actx=null; try{actx=new (window.AudioContext||window.webkitAudioContext)()}catch(e){actx=null}
  ;['pointerdown','keydown','touchstart'].forEach(ev=>addEventListener(ev,()=>{ if(actx&&actx.state==='suspended'){try{actx.resume()}catch(e){}} },{passive:true}));
  let soundOn=false; function blip(f=720,d=.12){ if(!soundOn||!actx) return; const o=actx.createOscillator(), g=actx.createGain(); o.type='triangle'; o.frequency.value=f; g.gain.value=.0001; o.connect(g).connect(actx.destination); o.start(); const t=actx.currentTime; g.gain.exponentialRampToValueAtTime(.14,t+.02); g.gain.exponentialRampToValueAtTime(.00001,t+d); o.stop(t+d+.02) }
  const music={ forest:{tempo:108,type:'triangle',vol:.2,steps:[[440,660],[0],[523],[0],[392,784],[0],[523],[0]]},
                city:{tempo:120,type:'sawtooth',vol:.2,steps:[[330],[0],[392],[0],[494],[0],[392],[0]]},
                ocean:{tempo:96,type:'sine',vol:.18,steps:[[294],[0],[330],[0],[392],[0],[330],[0]]},
                boss:{tempo:136,type:'square',vol:.25,steps:[[196,392],[0],[220,440],[0],[247,494],[0],[220,440],[0]]}};
  let musicMode=localStorage.getItem('esg.music')||'auto';
  let vol=(+localStorage.getItem('esg.vol')||60)/100;
  let musicBus=actx?actx.createGain():null; if(musicBus&&actx){ musicBus.gain.value=vol; musicBus.connect(actx.destination); }
  let seqTimer=null, seqBeat=.5, seqStep=0;
  function fadeTo(target=vol,secs=.5){ if(!actx||!musicBus) return; const now=actx.currentTime; try{musicBus.gain.cancelScheduledValues(now)}catch(e){} musicBus.gain.setValueAtTime(musicBus.gain.value,now); musicBus.gain.linearRampToValueAtTime(clamp(target,0,1), now+secs); }
  function stopSeq(){ if(seqTimer){clearInterval(seqTimer);seqTimer=null} fadeTo(0,.3) }
  function playTrack(kind){ if(!actx||!musicBus) return; if(kind==='none'){stopSeq();return} const p=music[kind]||music.forest; stopSeq(); seqBeat=60/(p.tempo||110); seqStep=0; seqTimer=setInterval(()=>{ const notes=p.steps[seqStep%p.steps.length]; for(const n of notes){ if(n){ const o=actx.createOscillator(), g=actx.createGain(); o.type=p.type; o.frequency.value=n; g.gain.value=.00001; o.connect(g).connect(musicBus); const t=actx.currentTime; o.start(); g.gain.exponentialRampToValueAtTime(p.vol,t+.01); g.gain.exponentialRampToValueAtTime(.00001,t+seqBeat*.9); o.stop(t+seqBeat);} } seqStep++; }, seqBeat*1000); fadeTo(vol,.4); }
  function applyMusic(bg){ if(musicMode==='none') return stopSeq(); if(musicMode==='auto'){ playTrack(bg==='city'?'city':bg==='ocean'?'ocean':'forest'); } else { playTrack(musicMode); } }

  // ÈóúÂç°ÈÖçÁΩÆ
  const LEVELS=[
    {goal:120,time:60,spawn:700,quiz:1,bg:'forest',illus:'üå≤',boss:false},
    {goal:200,time:55,spawn:650,quiz:1,bg:'city',illus:'üèôÔ∏è',boss:false},
    {goal:280,time:52,spawn:620,quiz:2,bg:'ocean',illus:'üåä',boss:true},
    {goal:360,time:50,spawn:600,quiz:2,bg:'forest',illus:'ü¶å',boss:false},
    {goal:460,time:48,spawn:560,quiz:2,bg:'city',illus:'üöã',boss:true},
    {goal:560,time:46,spawn:520,quiz:3,bg:'ocean',illus:'üêü',boss:false},
    {goal:680,time:44,spawn:500,quiz:3,bg:'forest',illus:'‚õ∞Ô∏è',boss:false},
    {goal:820,time:42,spawn:480,quiz:3,bg:'city',illus:'üåâ',boss:true},
    {goal:960,time:40,spawn:460,quiz:4,bg:'ocean',illus:'ü™∏',boss:false},
    {goal:1120,time:38,spawn:440,quiz:4,bg:'forest',illus:'ü¶Ö',boss:true}
  ];
  let LV=0; function setBg(kind){ board.classList.remove('bg-forest','bg-city','bg-ocean'); board.classList.add('bg-'+(kind||'forest')); $('illus').textContent=(LEVELS[LV]&&LEVELS[LV].illus)||'üå≤'; }
  function renderMap(){ const g=$('mapGrid'); g.innerHTML=''; const best=+(localStorage.getItem('esg.bestLV')||1); LEVELS.forEach((cfg,i)=>{ const lock=i+1>best; const n=document.createElement('div'); n.className='node fade-enter'; n.innerHTML='<b>ÈóúÂç° '+(i+1)+'</b> <span style="opacity:.75">'+cfg.bg+'ÔΩúÁõÆÊ®ô'+cfg.goal+'ÔΩú'+cfg.time+'s '+(cfg.boss?'ÔΩúBoss':'')+'</span><div style="margin-top:6px;text-align:right"><button class="btn" '+(lock?'disabled':'')+' data-lv="'+i+'">ÈñãÂßã</button></div>'; g.appendChild(n); }); g.querySelectorAll('button[data-lv]').forEach(b=>b.addEventListener('click',function(){ $('mapModal').classList.remove('show'); startLevel(+this.dataset.lv); })); }
  function saveBestLV(lv){ const best=+(localStorage.getItem('esg.bestLV')||1); if(lv>best){ localStorage.setItem('esg.bestLV', lv); }}

  const board=$('board'), fill=$('goalFill'), hpbar=$('hpbar'), hpfill=$('hpfill');
  let score=0, combo=0, timeLeft=60, running=false, planted=0, spawnTimer=null, tickTimer=null, bossEl=null, bossHp=0, bossTimer=null, drainAura=null;
  const EMOJIS=['üçÄ','üåø','üå≥','üíß','‚ö°','üåé'];

  function startLevel(i){ LV=i; const cfg=LEVELS[LV]||LEVELS[0]; const d=DIFF[diff]||DIFF.normal;
    const goal=Math.round(cfg.goal*d.goalMul), time=clamp(cfg.time+d.timePlus,20,999), spawn=Math.round(cfg.spawn*d.spawnMul);
    setBg(cfg.bg); applyMusic(cfg.bg); score=0; combo=0; timeLeft=time; $('level').textContent=(LV+1); $('goal').textContent=goal; $('time').textContent=timeLeft; $('score').textContent=0; $('trees').textContent=planted; fill.style.width='0%'; hpbar.style.display='none';
    if(spawnTimer) clearInterval(spawnTimer); if(tickTimer) clearInterval(tickTimer);
    running=true; spawnTimer=setInterval(spawnToken, spawn); tickTimer=setInterval(()=>{ if(!running) return; timeLeft--; $('time').textContent=timeLeft; if(timeLeft<=0){ gameOver(false); } },1000);
  }
  function spawnToken(){ if(!running) return; const t=document.createElement('div'); t.className='token'; const w=board.clientWidth, h=board.clientHeight; t.style.left=(Math.random()*(w-96)+6)+'px'; t.style.top=(Math.random()*(h-160)+100)+'px'; t.innerHTML='<div class="bubble"><div class="emoji">'+EMOJIS[Math.floor(Math.random()*EMOJIS.length)]+'</div></div>'; t.addEventListener('click',function(){hitToken(t)}); board.appendChild(t); setTimeout(()=>{ t.remove(); }, 3200); }
  function currentGoal(){ return parseInt($('goal').textContent,10)||0; }
  function hitToken(t){ if(!running) return; blip(720,.08); score+=10; combo=Math.min(99,combo+1); $('score').textContent=score; $('combo').textContent=combo+'x'; fill.style.width=Math.min(100,(score/currentGoal())*100)+'%'; t.remove(); if(score>=currentGoal()){ const cfg=LEVELS[LV]; if(cfg.boss && !bossEl){ spawnBoss(); } else { openQuiz(cfg.quiz); } } }

  // Boss
  function spawnBoss(){ bossHp=120; hpbar.style.display='block'; hpfill.style.width='100%'; bossEl=document.createElement('div'); bossEl.className='boss'; board.appendChild(bossEl); playTrack('boss');
    const tap=function(){ bossHp-=6; blip(180,.07); hpfill.style.width=Math.max(0,bossHp)/120*100+'%'; if(bossHp<=0){ cleanup(true); } };
    board.addEventListener('mousedown',tap); board.addEventListener('touchstart',tap,{passive:true});
    const bossTimer=setInterval(()=>{ if(!bossEl) return; const r=Math.random(); if(r<0.33){ skillShockwave(); } else if(r<0.66){ skillStun(); } else { Math.random()<0.5? skillMissile(): skillDrain(); } }, 2800);
    setTimeout(()=>{ if(bossEl){ cleanup(false,true); } }, 14000);

    function cleanup(kill=false,escape=false){ board.removeEventListener('mousedown',tap); board.removeEventListener('touchstart',tap); clearInterval(bossTimer); if(drainAura&&drainAura.parentNode) drainAura.parentNode.removeChild(drainAura); drainAura=null; if (bossEl) { bossEl.remove(); } bossEl=null; hpbar.style.display='none'; applyMusic(LEVELS[LV].bg); if(kill){ toast('Boss ÊìäÊïóÔºÅ'); openQuiz(LEVELS[LV].quiz); } else if(escape){ timeLeft=Math.max(0,timeLeft-10); toast('Boss ÈÄÉËµ∞ÔºÅ-10s'); } }
    function skillShockwave(){ const sw=document.createElement('div'); sw.className='shockwave'; board.appendChild(sw); setTimeout(()=>sw.remove(),1200); const lose=30; score=Math.max(0,score-lose); $('score').textContent=score; toast('üí• Ë°ùÊìäÊ≥¢ -'+lose+' ÂàÜ'); }
    function skillStun(){ const old=running; running=false; bossEl.classList.add('aura'); toast('‚õî ÊöàÁú© 1.5s'); setTimeout(()=>{ running=old; bossEl.classList.remove('aura'); },1500); }
    function skillMissile(){ let m=document.createElement('div'); m.className='missile'; const w=board.clientWidth, h=board.clientHeight; let x=w/2, y=h*0.56; m.style.left=x+'px'; m.style.top=y+'px'; board.appendChild(m); let t0=Date.now(); let timer=setInterval(()=>{ const target=document.querySelector('.token'); if(!target){ m.remove(); clearInterval(timer); return; } const rectT=target.getBoundingClientRect(); const rectB=board.getBoundingClientRect(); const tx=rectT.left-rectB.left+rectT.width/2; const ty=rectT.top-rectB.top+rectT.height/2; x+= (tx-x)*0.12; y+= (ty-y)*0.12; m.style.left=x+'px'; m.style.top=y+'px'; if(Math.hypot(tx-x,ty-y)<18){ const lose=20; score=Math.max(0,score-lose); $('score').textContent=score; toast('üéØ ËøΩËπ§È£õÂΩà -'+lose+' ÂàÜ'); try{target.remove();}catch(e){} clearInterval(timer); m.remove(); } if(Date.now()-t0>3500){ clearInterval(timer); m.remove(); } }, 60); }
    function skillDrain(){ if(drainAura&&drainAura.parentNode) drainAura.parentNode.removeChild(drainAura); drainAura=document.createElement('div'); drainAura.className='drain'; board.appendChild(drainAura); let t=0; const iv=setInterval(()=>{ if(!drainAura||!bossEl){ clearInterval(iv); return; } t++; if(t%4===0){ const lose=5; score=Math.max(0,score-lose); $('score').textContent=score; } },160); setTimeout(()=>{ if(drainAura&&drainAura.parentNode){ drainAura.remove(); drainAura=null; clearInterval(iv); } }, 2200); }
  }

  function gameOver(clear){ running=false; clearInterval(spawnTimer); clearInterval(tickTimer); if(clear){ celebrate(); toast('üéâ Á†¥ÈóúÔºÅ'); saveLB(); saveBestLV(LV+2); plantTree('üå±'); setTimeout(()=>nextLevel(),900); } else { toast('ÊôÇÈñìÂà∞Ôºå‰∏ãÊ¨°ÂÜç‰æÜÔºÅ'); saveLB(); } }
  function nextLevel(){ if(LV+1>=LEVELS.length){ toast('üèÅ ÂÖ®ÈÄöÈóúÔºÅ'); return; } startLevel(LV+1); }

  // Ê®π & ÂúñÈëë
  const TREEDEX=[{name:'Âè∞ÁÅ£Êùâ',desc:'Âõ∫Á¢≥‰Ω≥ÔºåÈáùËëâÊ®π',stage:0,unlocked:true},{name:'ÁÉèÂøÉÁü≥',desc:'Ê®üÁßëÔºåËÄêÈô∞ËÄêÈ¢®',stage:0,unlocked:false},{name:'Ê•ìÈ¶ô',desc:'ÁßãÂ≠£Á¥ÖËëâ',stage:0,unlocked:false},{name:'Ê®üÊ®π',desc:'Â∏∏Á∂†Ë°åÈÅìÊ®π',stage:0,unlocked:false},{name:'Áõ∏ÊÄùÊ®π',desc:'Âõ∫Ê∞ÆÈÄ†ÊûóÊ®πÁ®Æ',stage:0,unlocked:false},{name:'Â±±ÊØõÊ´∏',desc:'È´òÊµ∑ÊãîÈóäËëâ',stage:0,unlocked:false}];
  const stageIcon=['üå±','üåø','üå≥'];
  function plantTree(icon){ planted++; $('trees').textContent=planted; const el=document.createElement('div'); el.className='tree'; el.style.setProperty('--x',(Math.random()*(board.clientWidth-80))+'px'); el.textContent=icon||stageIcon[Math.floor(Math.random()*3)]; board.appendChild(el); setTimeout(()=>el.remove(),4800); }
  function renderDex(){ const g=$('dexGrid'); g.innerHTML=''; TREEDEX.forEach(t=>{ const n=document.createElement('div'); n.className='node'; const badge=t.unlocked?'<span style="font-size:12px;background:#dcfce7;padding:2px 8px;border-radius:999px">Â∑≤Ëß£Èéñ</span>':'<span style="font-size:12px;background:#e5e7eb;padding:2px 8px;border-radius:999px">Êú™Ëß£Èéñ</span>'; const stage=stageIcon[t.stage]; n.innerHTML='<b>'+t.name+'</b> '+badge+' <span style="font-size:12px;background:#e2e8f0;padding:2px 8px;border-radius:999px">ÈöéÊÆµÔºö'+stage+'</span><p style="margin:6px 0 0;opacity:.9">'+t.desc+'</p>'+(t.unlocked?'<button class="btn" data-plant="1">Á®Æ‰∏ã</button>':''); g.appendChild(n); }); g.querySelectorAll('button[data-plant]').forEach(b=>b.addEventListener('click',()=>plantTree())); }

  // ÊàêÂ∞±ÔºàÁ§∫ÊÑèÔºâ
  const ACH=[{id:'combo30',name:'ÈÄ£ÊìäÁéã',desc:'ÈÄ£Êìä ‚â• 30',check:()=>combo>=30},{id:'planter',name:'Á®ÆÊ®πÈÅî‰∫∫',desc:'Á¥ØË®àÁ®ÆÊ®π ‚â• 50',check:()=>planted>=50}];
  function renderAch(){ const g=$('achGrid'); g.innerHTML=''; let owned={}; try{owned=JSON.parse(localStorage.getItem('esg.ach')||'{}')}catch(e){} ACH.forEach(a=>{ const n=document.createElement('div'); n.className='node'; const ok=owned[a.id]; n.innerHTML='<b>'+(ok?'‚úÖ':'')+' '+a.name+'</b><p style="margin:6px 0 0;opacity:.9">'+a.desc+'</p>'; g.appendChild(n); }); }

  // ÂïèÁ≠î + CSV
  const CAT=['Energy','Water','Air','Renewable','Carbon']; let weight={Energy:3,Water:2,Air:2,Renewable:3,Carbon:3};
  function buildTabs(){ const box=$('qTabs'); box.innerHTML=''; CAT.forEach(c=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=c; b.dataset.c=c; b.addEventListener('click',()=>{ weight[c]=Math.min(5,(weight[c]||1)+1); updateTabs(); toast(c+' Ê¨äÈáç +1'); }); box.appendChild(b); }); updateTabs(); }
  function updateTabs(){ Array.prototype.forEach.call(document.querySelectorAll('#qTabs .btn'),function(b){ const c=b.dataset.c; const on=(weight[c]||1)>=4; if(on){ b.classList.add('primary'); }else{ b.classList.remove('primary'); } }); updateStats(); }
  let QUIZ=[
    {cat:'Energy',q:'ÂÜ∑Ê∞£Ê∫´Â∫¶ÊØèÂçá 1¬∞C Á¥ÑÂèØÁúÅÈõªÔºü',a:['1%','3%','6%','12%'],i:2,why:'Âª∫Ë≠∞ 26‚Äì28¬∞C„ÄÇ'},
    {cat:'Water',q:'ÂÆ∂Â∫≠ÁúÅÊ∞¥Â•ΩÊñπÊ≥ïÔºü',a:['Ê∞¥ÁÆ°Áõ¥Ê≤ñÊ¥óËªä','ÂõûÊî∂Ê¥óË°£Ê©üÈ§òÊ∞¥ÊãñÂú∞','Èï∑ÊôÇÈñìÊ≤ñÊæ°','ÂÖ®ÈñãÊ∞¥ÈæçÈ†≠'],i:1},
    {cat:'Air',q:'PM2.5 ÊåáÁõ¥ÂæëÂ∞èÊñºÔºü',a:['2.5 Œºm','10 Œºm','25 Œºm','1 Œºm'],i:0},
    {cat:'Renewable',q:'‰ΩïËÄÖÂ±¨ÈñìÊ≠áÊÄßËÉΩÊ∫êÔºü',a:['Ê∞¥Âäõ','Âú∞ÁÜ±','Â§™ÈôΩÂÖâÈõª','Ê†∏ËÉΩ'],i:2},
    {cat:'Carbon',q:'GHG ÂÖ≠Â§ßÊ∞£È´î‰∏çÂåÖÂê´Ôºü',a:['CO‚ÇÇ','CH‚ÇÑ','N‚ÇÇO','O‚ÇÇ'],i:3,why:'ÂÖ≠Á®ÆÔºöCO‚ÇÇ„ÄÅCH‚ÇÑ„ÄÅN‚ÇÇO„ÄÅHFCs„ÄÅPFCs„ÄÅSF‚ÇÜ„ÄÇ'},
    {cat:'Carbon',q:'ÁØÑÁñá2ÊòØÔºü',a:['Âì°Â∑•ÈÄöÂã§','Ë≥ºÂÖ•ÈõªÂäõ','Âª¢Ê£ÑÁâ©ËôïÁêÜ','Ë≥áÊú¨Ë≤°'],i:1}
  ];
  let stats={right:0,wrong:0};
  function updateStats(){ $('statTotal').textContent=QUIZ.length; $('statRight').textContent=stats.right; $('statWrong').textContent=stats.wrong; const t=stats.right+stats.wrong; $('statAcc').textContent=t?Math.round(stats.right/t*100)+'%':'0%'; }
  function csvToQuiz(text){
    const lines=text.split(/\r?\n/).filter(function(x){return x.trim()});
    let add=0;
    for(let idx=0; idx<lines.length; idx++){
      const L = lines[idx];
      const parts = L.split(',');
      if(parts.length < 4) continue;
      const cat = parts[0], q = parts[1], aStr = parts[2], iStr = parts[3], why = parts.slice(4).join(','); // ÂÖÅË®± why ÂÖßÂê´ÈÄóËôü
      const a=aStr.split('|');
      const i=parseInt(iStr,10);
      if(isNaN(i)) continue;
      QUIZ.push({cat:String(cat).trim(),q:String(q).trim(),a:a.map(function(s){return String(s).trim()}),i:i,why:String(why||'').trim()});
      add++;
    }
    toast('üì• È°åÂ∫´Â∑≤ÂåØÂÖ• '+add+' Ë°å'); updateStats();
  }
  function quizToCsv(){
    const esc = function(s){ return String(s==null?'':s).replace(/"/g,'""'); };
    return QUIZ.map(function(it){
      const why = '"'+esc(it.why||'')+'"';
      return [it.cat, it.q, it.a.join('|'), it.i, why].join(',');
    }).join('\n');
  }
  let needCorrect=1, correctThisRound=0, qIndex=-1;
  function openQuiz(n){ needCorrect=n; correctThisRound=0; $('quizModal').classList.add('show'); buildTabs(); renderQuiz(); }
  function pickQuestion(){ const bag=[]; for(let i=0;i<QUIZ.length;i++){ const w=weight[QUIZ[i].cat]||1; for(let k=0;k<w;k++) bag.push(i); } return bag[Math.floor(Math.random()*bag.length)]||0; }
  function renderQuiz(){ qIndex=pickQuestion(); const it=QUIZ[qIndex]; const box=$('quizBox'); let opts=''; for(let idx=0; idx<it.a.length; idx++){ const o=it.a[idx]; opts+='<label style="display:block;margin:6px 0"><input type="radio" name="q" value="'+idx+'"> '+o+'</label>'; } box.innerHTML='<div class="node"><b>['+it.cat+'] '+it.q+'</b>'+opts+'<div style="margin-top:8px"><button class="btn" id="submitQ">Êèê‰∫§</button></div><div id="qFeedback" style="margin-top:6px;font-weight:900"></div></div>'; $('submitQ').addEventListener('click',checkQ); updateStats(); }
  function checkQ(){ const it=QUIZ[qIndex]; const sel=document.querySelector('input[name="q"]:checked'); if(!sel) return; if(+sel.value===it.i){ blip(860,.12); $('qFeedback').textContent='‚úÖ Á≠îÂ∞ç‰∫ÜÔºÅ'+(it.why?(' '+it.why):''); stats.right++; correctThisRound++; plantTree('üåø'); if(correctThisRound>=needCorrect){ $('quizModal').classList.remove('show'); gameOver(true); } } else { blip(200,.12); $('qFeedback').textContent='‚ùå ÂÜçÊÉ≥ÊÉ≥ÔΩû '+(it.why||''); stats.wrong++; } updateStats(); }
  $('nextQ').addEventListener('click',renderQuiz);
  $('importCsv').addEventListener('click',()=>{ const f=$('csvQ').files&&$('csvQ').files[0]; if(!f) return alert('Ë´ãÂÖàÈÅ∏Êìá .csv'); const fr=new FileReader(); fr.onload=e=>csvToQuiz(String((e.target&&e.target.result)||'')); fr.readAsText(f,'utf-8'); });
  $('exportCsv').addEventListener('click',()=>{ const blob=new Blob([quizToCsv()],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz_export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); });

  // Facts
  const FACTS=['ÂÜ∑Ê∞£ÊØèÈ´ò 1¬∞C Á¥ÑÁúÅ 6% Èõª','ÂæÖÊ©üÈõªÂäõ‰ΩîÂÆ∂Êà∂ 5‚Äì10%','LED ÂèØÁúÅ 50% Èõª','Â§ßÁúæÈÅãËº∏ËÉΩÈôç‰Ωé‰∫∫ÂùáÊéíÊîæ','PM2.5 Áõ¥ÂæëÂ∞èÊñº 2.5Œºm','GHG ÂÖ≠È°ûÔºöCO‚ÇÇ„ÄÅCH‚ÇÑ„ÄÅN‚ÇÇO„ÄÅHFCs„ÄÅPFCs„ÄÅSF‚ÇÜ','S2ÔºöË≥ºÂÖ•Èõª/ÁÜ±/ÂÜ∑ÈÄ†ÊàêÁöÑÈñìÊé•ÊéíÊîæ'];
  function renderFacts(){ const ul=$('factsList'); ul.innerHTML=''; for(let i=0;i<FACTS.length;i++){ const li=document.createElement('li'); li.textContent=FACTS[i]; ul.appendChild(li); } }

  // Leaderboard
  function saveLB(){ const raw=localStorage.getItem('esg.lb.v54')||'[]'; let arr=[]; try{arr=JSON.parse(raw)}catch(e){} arr.push({name:localStorage.getItem('esg.player')||'Player', lv:LV+1, score:score, trees:planted, ts:Date.now()}); arr.sort((a,b)=> b.score-a.score); arr=arr.slice(0,50); localStorage.setItem('esg.lb.v54', JSON.stringify(arr)); }
  function renderLB(){ const raw=localStorage.getItem('esg.lb.v54')||'[]'; let arr=[]; try{arr=JSON.parse(raw)}catch(e){} const tb=$('lbBody'); tb.innerHTML=''; for(let i=0;i<arr.length;i++){ const r=arr[i]; const tr=document.createElement('tr'); const dt=new Date(r.ts); tr.innerHTML='<td>'+(i+1)+'</td><td>'+r.name+'</td><td>'+r.lv+'</td><td>'+r.score+'</td><td>'+r.trees+'</td><td>'+dt.toLocaleDateString()+'</td>'; tb.appendChild(tr); } }
  async function pushOnline(){ const fb=$('firebaseUrl').value.trim(); const gs=$('sheetsUrl').value.trim(); const data=localStorage.getItem('esg.lb.v54')||'[]'; if(fb){ try{ await fetch(fb,{method:'POST',headers:{'Content-Type':'application/json'},body:data}); toast('Firebase Â∑≤‰∏äÂÇ≥'); }catch(e){ alert('Firebase ‰∏äÂÇ≥Â§±ÊïóÔºö'+e.message); } } if(gs){ try{ await fetch(gs,{method:'POST',headers:{'Content-Type':'application/json'},body:data}); toast('Sheets Â∑≤‰∏äÂÇ≥'); }catch(e){ alert('Sheets ‰∏äÂÇ≥Â§±ÊïóÔºö'+e.message); } } if(!fb&&!gs){ alert('Ë´ãËº∏ÂÖ• Firebase Êàñ Sheets Á´ØÈªû'); } }
  async function pullOnline(){ const fb=$('firebaseUrl').value.trim(); const gs=$('sheetsUrl').value.trim(); try{ if(fb){ const r=await fetch(fb); const a=await r.json(); localStorage.setItem('esg.lb.v54', JSON.stringify(a)); } else if(gs){ const r=await fetch(gs); const a=await r.json(); localStorage.setItem('esg.lb.v54', JSON.stringify(a)); } else { return alert('Ë´ãËº∏ÂÖ•Á´ØÈªû'); } renderLB(); toast('Â∑≤Êõ¥Êñ∞'); }catch(e){ alert('Êõ¥Êñ∞Â§±ÊïóÔºö'+e.message); } }

  // GHG ‰ªªÂãôÊ∏ÖÂñÆÔºàS1/S2/S3Ôºâ
  const GHG=[{s:'S1 Áõ¥Êé•ÊéíÊîæ', items:['ÈçãÁàê/ÁôºÈõªÊ©üÁáÉÊñôÁ¥ÄÈåÑ','Ë£ΩÁ®ãÈÄ∏Êï£ÊéíÊîæË®òÈåÑ','ÂÜ∑Â™íË£úÂÖÖÈáè'], hint:'ÂÖ¨Âè∏Áõ¥Êé•ÁáÉÁáí / Ë£ΩÁ®ã / ÂÜ∑Â™í'},
             {s:'S2 Ë≥ºÂÖ•ËÉΩÊ∫êÈñìÊé•', items:['ÈõªË≤ªÂ∏≥ÂñÆÔºàÊúàÔºâ','Ëí∏Ê±Ω/ÂÜ∑/ÁÜ±Ë≥ºË≤∑Èáè','ÂÜçÁîüËÉΩÊ∫êÊÜëË≠â'], hint:'Â§ñË≥ºÈõª/ÁÜ±/ÂÜ∑ÁöÑÈñìÊé•ÊéíÊîæ'},
             {s:'S3 ÂÖ∂‰ªñÈñìÊé•', items:['ÈÄöÂã§/Â∑ÆÊóÖÈáåÁ®ã','‰∏ä/‰∏ãÊ∏∏ÈÅãËº∏','Âª¢Ê£ÑÁâ©ËôïÁêÜ','Ë≥áÊú¨Ë≤°'], hint:'ÂÉπÂÄºÈèà‰∏ä‰∏ãÊ∏∏Ê¥ªÂãï'}];
  function renderGHG(){ const tb=$('ghgBody'); tb.innerHTML=''; for(let g=0; g<GHG.length; g++){ const x=GHG[g]; const tr=document.createElement('tr'); const items=x.items.map(function(s){return '<label class="node" style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="ghg"> <span>'+s+'</span></label>';}).join(''); tr.innerHTML='<td style="width:180px;vertical-align:top"><b>'+x.s+'</b><div style="opacity:.75">'+x.hint+'</div></td><td style="vertical-align:top"><div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:6px">'+items+'</div></td>'; tb.appendChild(tr); } }

  // ‰ªªÂãôÔºàÊØèÊó•/ÊØèÈÄ±Ôºâ
  function genDailyTasks(){ return [
    {id:'dq1',text:'ÂÆåÊàê 1 Ê¨°ÈóúÂç°',need:1},
    {id:'dq2',text:'Á≠îÂ∞ç 3 È°åÂ∞èÁü•Ë≠ò',need:3},
    {id:'dq3',text:'Á®Æ‰∏ã 3 Ê£µÊ®π',need:3}
  ]; }
  function genWeeklyTasks(){ return [
    {id:'wq1',text:'Á¥ØÁ©ç 5 Ê¨°ÈÄöÈóú',need:5},
    {id:'wq2',text:'Á¥ØÁ©ç 20 È°åÁ≠îÂ∞ç',need:20},
    {id:'wq3',text:'Á¥ØÁ©ç 1000 ÂàÜ',need:1000},
    {id:'wq4',text:'Á®Æ‰∏ã 30 Ê£µÊ®π',need:30},
    {id:'wq5',text:'ÂÆåÊàê 5 È†Ö GHG Ê∏ÖÂñÆÂãæÈÅ∏',need:5}
  ]; }
  function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function weekKey(){ const d=new Date(); const base=new Date(d.getFullYear(),0,1); const wk=Math.ceil((((d-base)/86400000)+base.getDay()+1)/7); return d.getFullYear()+'-W'+wk; }
  function ensureTasks(){ const dk='esg.daily.'+todayKey(), wk='esg.weekly.'+weekKey(); if(!localStorage.getItem(dk)){ localStorage.setItem(dk, JSON.stringify({tasks:genDailyTasks(),done:{}})); } if(!localStorage.getItem(wk)){ localStorage.setItem(wk, JSON.stringify({tasks:genWeeklyTasks(),done:{}})); } }
  function taskLi(t,scope){ const done=(scope.done[t.id]); return '<li><div class="todo-top"><label><input type="checkbox" data-scope="'+scope.key+'" data-id="'+t.id+'" '+(done?'checked':'')+'> '+t.text+'</label><span class="todo-badge">'+(scope.key==='D'?'‰ªäÊó•':'Êú¨ÈÄ±')+'</span></div><div class="todo-bar"><div class="todo-fill" style="width:'+(done?100:0)+'%"></div></div></li>'; }
  function renderTasks(){ ensureTasks(); const dk='esg.daily.'+todayKey(), wk='esg.weekly.'+weekKey(); const D=JSON.parse(localStorage.getItem(dk)); const W=JSON.parse(localStorage.getItem(wk)); const ulD=$('dailyList'), ulW=$('weeklyList'); if(ulD){ ulD.innerHTML=D.tasks.map(function(t){return taskLi(t,{key:'D',done:D.done})}).join(''); } if(ulW){ ulW.innerHTML=W.tasks.map(function(t){return taskLi(t,{key:'W',done:W.done})}).join(''); }
    Array.prototype.forEach.call(document.querySelectorAll('#questModal input[type="checkbox"]'),function(cb){ cb.addEventListener('change',onTaskToggle); }); }
  function onTaskToggle(e){ ensureTasks(); const key=e.target.getAttribute('data-scope'); const id=e.target.getAttribute('data-id'); const store=(key==='D'?'esg.daily.'+todayKey():'esg.weekly.'+weekKey()); const data=JSON.parse(localStorage.getItem(store)); data.done[id]=e.target.checked; localStorage.setItem(store, JSON.stringify(data));
    const li=e.target.closest('li'); if(li){ const fill=li.querySelector('.todo-fill'); if(fill) fill.style.width=e.target.checked?'100%':'0%'; } }

  // ÂèñÂêç / Á∂ÅÂÆö
  function ensureName(){ if(!localStorage.getItem('esg.player')){ $('nameModal').classList.add('show'); } }
  $('saveName').addEventListener('click',()=>{ const v=$('nameInput').value.trim()||'Player'; localStorage.setItem('esg.player',v); $('player').textContent=v; $('nameModal').classList.remove('show'); });
  $('soundBtn').addEventListener('click',()=>{ soundOn=!soundOn; $('soundBtn').textContent=soundOn?'üîä':'üîà'; if(soundOn) blip(640,.1) });
  $('langBtn').addEventListener('click',()=>{ LANG=(LANG==='zh'?'en':'zh'); localStorage.setItem('esg.lang',LANG); applyLang(); });
  $('startBtn').addEventListener('click',()=>{ ensureName(); planted=0; $('trees').textContent=0; startLevel(0); });
  $('pauseBtn').addEventListener('click',()=>{ running=false; clearInterval(spawnTimer); clearInterval(tickTimer); toast('Â∑≤Êö´ÂÅú'); });

  // Modal Á∂ÅÂÆö
  $('mapBtn').addEventListener('click',()=>{ renderMap(); $('mapModal').classList.add('show'); });
  $('resetProgress').addEventListener('click',()=>{ localStorage.setItem('esg.bestLV',1); toast('ÈÄ≤Â∫¶Â∑≤ÈáçÁΩÆ'); renderMap(); });
  $('treeBtn').addEventListener('click',()=>{ renderDex(); $('treeModal').classList.add('show'); });
  $('factsBtn').addEventListener('click',()=>{ renderFacts(); $('factsModal').classList.add('show'); });
  $('achBtn').addEventListener('click',()=>{ renderAch(); $('achModal').classList.add('show'); });
  $('lbBtn').addEventListener('click',()=>{ renderLB(); $('lbModal').classList.add('show'); });
  $('pushOnline').addEventListener('click',pushOnline); $('pullOnline').addEventListener('click',pullOnline);

  // Áõ¥Êé•ÈñãÂïüÂ∞èÁü•Ë≠òÊåâÈàï
  $('quizBtn').addEventListener('click',()=>{ openQuiz(1); });

  // ‰ªªÂãô‰∏≠ÂøÉ
  $('questBtn').addEventListener('click',()=>{ renderTasks(); renderGHG(); $('questModal').classList.add('show'); bindQuestPager(); showQuestPage(0); });

  // ÈóúÈñâÊåâÈàï
  Array.prototype.forEach.call(document.querySelectorAll('[data-close]'), function(b){
    b.addEventListener('click',function(){ const id=b.getAttribute('data-close'); $(id).classList.remove('show'); });
  });

  // Music modal
  $('musicBtn').addEventListener('click',()=>{ $('musicSel').value=musicMode; $('vol').value=Math.round(vol*100); $('musicModal').classList.add('show'); });
  $('musicPreview').addEventListener('click',()=>{ const sel=$('musicSel').value; if(sel==='none') stopSeq(); else playTrack(sel==='auto'?'forest':sel); });
  $('musicSave').addEventListener('click',()=>{ musicMode=$('musicSel').value; localStorage.setItem('esg.music',musicMode); vol=(+$('vol').value)/100; localStorage.setItem('esg.vol',Math.round(vol*100)); if(musicBus) musicBus.gain.value=vol; $('musicModal').classList.remove('show'); applyMusic((LEVELS[LV]&&LEVELS[LV].bg)||'forest'); });

  // ‰ªªÂãô PagerÔºàÂãïÊÖãÈ†ÅÊï∏Ôºâ
  let questPage=0;
  function questPageCount(){ return document.querySelectorAll('#questTrack .pager-page').length; }
  function showQuestPage(i){
    const max = questPageCount() - 1;
    questPage = Math.max(0, Math.min(max, i));
    const track=$('questTrack');
    if(track){ track.style.transform='translateX(-'+(questPage*100)+'%)'; }
    const dots=$('questDots');
    if(dots){
      dots.innerHTML='';
      for(let k=0;k<questPageCount();k++){
        const d=document.createElement('div');
        d.className='pager-dot'+(k===questPage?' active':'');
        d.addEventListener('click',(()=>{ const idx=k; return ()=>showQuestPage(idx); })());
        dots.appendChild(d);
      }
    }
  }
  function bindQuestPager(){
    $('questPrev') && $('questPrev').addEventListener('click',()=>showQuestPage(questPage-1));
    $('questNext') && $('questNext').addEventListener('click',()=>showQuestPage(questPage+1));
    const pager=$('questPager'); let sx=0,dx=0;
    pager && pager.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;dx=0;},{passive:true});
    pager && pager.addEventListener('touchmove',e=>{dx=e.touches[0].clientX-sx;},{passive:true});
    pager && pager.addEventListener('touchend',()=>{ if(Math.abs(dx)>50){ showQuestPage(questPage+(dx<0?1:-1)); } });
  }

  // ÂàùÂßãÂåñ
  document.addEventListener('DOMContentLoaded',()=>{ applyLang(); renderDex(); renderFacts(); renderMap(); });
})();
</script>
</body>
</html>
